<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outdials Power Dialer</title>
    <link rel="icon" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #000000;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 48px;
        }

        .header h1 {
            color: #ffffff;
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
        }

        .broken-o {
            display: inline-block;
            width: 42px;
            height: 48px;
            position: relative;
            margin: 0 -2px;
        }

        .broken-o svg {
            width: 100%;
            height: 100%;
        }

        .card {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 48px;
            box-shadow: 0 1px 3px rgba(255, 255, 255, 0.06), 0 1px 2px rgba(255, 255, 255, 0.04);
            margin-bottom: 24px;
            border: 1px solid #333333;
        }

        .login-container {
            text-align: center;
            padding: 40px 20px;
        }

        .login-container h2 {
            color: #ffffff;
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .login-container p {
            color: #cccccc;
            font-size: 15px;
            margin-bottom: 32px;
        }

        .btn {
            padding: 14px 28px;
            font-size: 15px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
            font-family: inherit;
        }

        .btn-primary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 1px 2px rgba(255, 255, 255, 0.1);
        }

        .btn-primary:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 4px rgba(255, 255, 255, 0.15);
        }

        .btn-control {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 18px;
            padding: 18px 48px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 8px rgba(255, 255, 255, 0.1);
        }

        .btn-control:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.15);
        }

        .btn-control:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-stop {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: rgba(239, 68, 68, 0.9);
        }

        .btn-stop:hover:not(:disabled) {
            background: rgba(239, 68, 68, 0.25);
            border-color: rgba(239, 68, 68, 0.4);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-logout {
            background: #2a2a2a;
            color: #cccccc;
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 8px;
        }

        .btn-logout:hover {
            background: #3a3a3a;
        }

        .user-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
            padding: 24px;
            background: #0a0a0a;
            border-radius: 12px;
            border: 1px solid #333333;
        }

        .user-details h3 {
            color: #ffffff;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .user-details p {
            color: #cccccc;
            font-size: 14px;
        }

        .controls-section h3 {
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 24px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            color: #ffffff;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        select, input[type="tel"] {
            width: 100%;
            padding: 14px 16px;
            font-size: 15px;
            border: 1px solid #333333;
            border-radius: 10px;
            background: #0a0a0a;
            color: #ffffff;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
            font-family: inherit;
        }

        input[type="tel"] {
            cursor: text;
        }

        select:focus, input[type="tel"]:focus {
            outline: none;
            border-color: #6b9080;
            box-shadow: 0 0 0 3px rgba(107, 144, 128, 0.1);
        }

        select:disabled, input[type="tel"]:disabled {
            background: #1a1a1a;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .call-race-container {
            display: none;
            padding: 40px 0;
            margin-bottom: 32px;
        }

        .call-race-container.active {
            display: block;
        }

        .call-race-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            max-width: 900px;
            margin: 0 auto;
        }

        .race-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.4s ease;
            position: relative;
        }

        .race-card.ringing {
            animation: cardPulse 0.8s ease-in-out infinite;
        }

        .race-card.dialing-placeholder {
            animation: dialingShimmer 1.5s ease-in-out infinite;
        }

        @keyframes dialingShimmer {
            0%, 100% { 
                background: rgba(255, 255, 255, 0.05);
                border-color: rgba(255, 255, 255, 0.15);
            }
            50% { 
                background: rgba(255, 255, 255, 0.1);
                border-color: rgba(255, 255, 255, 0.3);
            }
        }

        .race-card.human {
            background: rgba(34, 197, 94, 0.15);
            border-color: rgba(34, 197, 94, 0.5);
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.3);
            animation: none;
            transform: scale(1.05);
        }

        .race-card.machine {
            background: rgba(251, 191, 36, 0.1);
            border-color: rgba(251, 191, 36, 0.3);
            opacity: 0.4;
            animation: none;
        }

        .race-card.busy {
            background: rgba(255, 107, 53, 0.1);
            border-color: rgba(255, 107, 53, 0.3);
            opacity: 0.4;
            animation: none;
        }

        .race-card.ended {
            opacity: 0.3;
            animation: none;
        }

        @keyframes cardPulse {
            0%, 100% { 
                border-color: rgba(255, 255, 255, 0.3);
                box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
            }
            50% { 
                border-color: rgba(255, 255, 255, 0.6);
                box-shadow: 0 0 25px rgba(255, 255, 255, 0.4);
            }
        }

        .race-card-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .race-card.ringing .race-card-status {
            color: rgba(255, 255, 255, 0.7);
        }

        .race-card.dialing-placeholder .race-card-status {
            color: rgba(255, 255, 255, 0.5);
        }

        .race-card.human .race-card-status {
            color: rgba(34, 197, 94, 1);
        }

        .race-card.machine .race-card-status {
            color: rgba(251, 191, 36, 0.9);
        }

        .race-card.busy .race-card-status {
            color: rgba(255, 107, 53, 0.9);
        }

        .race-card.ended .race-card-status {
            color: rgba(255, 255, 255, 0.4);
        }

        .race-status-icon {
            font-size: 18px;
        }

        .race-card-name {
            color: #ffffff;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .race-card.dialing-placeholder .race-card-name {
            opacity: 0.5;
        }

        .race-card.machine .race-card-name,
        .race-card.busy .race-card-name,
        .race-card.ended .race-card-name {
            opacity: 0.6;
        }

        .race-card-info {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            margin-bottom: 4px;
        }

        .race-card.dialing-placeholder .race-card-info {
            opacity: 0.4;
        }

        .race-card.machine .race-card-info,
        .race-card.busy .race-card-info,
        .race-card.ended .race-card-info {
            opacity: 0.5;
        }

        .race-winner-badge {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(34, 197, 94, 1);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
        }

        .race-close-btn {
            position: absolute;
            top: -12px;
            right: -12px;
            background: rgba(239, 68, 68, 0.9);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
            transition: all 0.2s ease;
        }

        .race-close-btn:hover {
            background: rgba(239, 68, 68, 1);
            transform: scale(1.1);
        }

        .race-note-btn {
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(59, 130, 246, 0.9);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            transition: all 0.2s ease;
        }

        .race-note-btn:hover {
            background: rgba(59, 130, 246, 1);
            transform: translateX(-50%) scale(1.1);
        }

        .note-compartment {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 20px;
            width: 100%;
            background: rgba(26, 26, 26, 0.98);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            z-index: 15;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .note-compartment.open {
            max-height: 400px;
            opacity: 1;
        }

        .note-compartment-header {
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .note-compartment-subheader {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            margin-bottom: 16px;
        }

        .note-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            background: #0a0a0a;
            border: 1px solid #333333;
            border-radius: 8px;
            color: #ffffff;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 12px;
            transition: border-color 0.2s ease;
        }

        .note-textarea:focus {
            outline: none;
            border-color: rgba(59, 130, 246, 0.5);
        }

        .note-textarea::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .note-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .note-btn {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .note-btn-cancel {
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .note-btn-cancel:hover {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
        }

        .note-btn-save {
            background: rgba(59, 130, 246, 0.9);
            color: white;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .note-btn-save:hover {
            background: rgba(59, 130, 246, 1);
        }

        .note-btn-save.saved {
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.15);
            cursor: default;
        }

        .note-btn-save.saved:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .call-race-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            max-width: 900px;
            margin: 0 auto;
            position: relative;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 32px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-indicator.idle {
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .status-indicator.dialing {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status-indicator.on-call {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
        }

        .status-indicator.dialing .status-dot {
            background: #ef4444;
            animation: pulse 2s ease-in-out infinite;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        .status-indicator.on-call .status-dot {
            background: #ef4444;
            animation: pulse 2s ease-in-out infinite;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .error {
            background: #2a1a1a;
            border: 1px solid #4a2a2a;
            color: #ff6b6b;
            padding: 16px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            font-size: 14px;
        }

        .success {
            background: #1a2a1a;
            border: 1px solid #2a4a2a;
            color: #6bff6b;
            padding: 16px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            font-size: 14px;
        }

        .button-group {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .analytics-section {
            margin-bottom: 40px;
        }

        .analytics-header {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 20px 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s ease;
        }

        .analytics-header:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.25);
        }

        .analytics-header h3 {
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 0;
        }

        .analytics-chevron {
            width: 20px;
            height: 20px;
            stroke: rgba(255, 255, 255, 0.6);
            transition: transform 0.3s ease;
        }

        .analytics-section.expanded .analytics-chevron {
            transform: rotate(180deg);
        }

        .analytics-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .analytics-section.expanded .analytics-content {
            max-height: 2000px;
        }

        .analytics-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .analytics-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .analytics-stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .analytics-stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .analytics-stat-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .analytics-stat-value {
            color: #ffffff;
            font-size: 28px;
            font-weight: 700;
        }

        .session-history {
            margin-top: 24px;
        }

        .session-history h4 {
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 16px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table th {
            color: rgba(255, 255, 255, 0.6);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        }

        .history-table td {
            color: #ffffff;
            font-size: 14px;
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .history-table tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .history-empty {
            color: rgba(255, 255, 255, 0.4);
            text-align: center;
            padding: 32px;
            font-size: 14px;
        }

        /* Hero Card Styles */
        .hero-card-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .hero-card-container.active {
            display: flex;
        }

        .hero-card {
            background: #1a1a1a;
            border: 3px solid rgba(34, 197, 94, 0.6);
            border-radius: 24px;
            padding: 48px;
            max-width: 600px;
            width: 100%;
            position: relative;
            box-shadow: 0 0 40px rgba(34, 197, 94, 0.4), 0 20px 60px rgba(0, 0, 0, 0.6);
            animation: heroCardPulse 2s ease-in-out infinite;
        }

        @keyframes heroCardPulse {
            0%, 100% { 
                border-color: rgba(34, 197, 94, 0.6);
                box-shadow: 0 0 40px rgba(34, 197, 94, 0.4), 0 20px 60px rgba(0, 0, 0, 0.6);
            }
            50% { 
                border-color: rgba(34, 197, 94, 0.9);
                box-shadow: 0 0 60px rgba(34, 197, 94, 0.6), 0 20px 60px rgba(0, 0, 0, 0.6);
            }
        }

        .hero-card-badge {
            position: absolute;
            top: -16px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(34, 197, 94, 1);
            color: white;
            padding: 10px 24px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 0 4px 16px rgba(34, 197, 94, 0.5);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .hero-card-content {
            margin-top: 24px;
        }

        .hero-card-name {
            color: #ffffff;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 24px;
            text-align: center;
        }

        .hero-card-info-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            margin-bottom: 32px;
        }

        .hero-card-info-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 16px 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .hero-card-info-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 6px;
        }

        .hero-card-info-value {
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
        }

        .hero-card-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 32px;
        }

        .hero-card-btn {
            padding: 14px 32px;
            font-size: 15px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .hero-card-btn-dismiss {
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .hero-card-btn-dismiss:hover {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
        }

        .hero-card-btn-note {
            background: rgba(59, 130, 246, 0.9);
            color: white;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .hero-card-btn-note:hover {
            background: rgba(59, 130, 246, 1);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .hero-card-note-compartment {
            margin-top: 24px;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .hero-card-note-compartment.open {
            max-height: 400px;
            opacity: 1;
        }

        .hero-note-header {
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .hero-note-textarea {
            width: 100%;
            min-height: 120px;
            padding: 14px;
            background: #0a0a0a;
            border: 1px solid #333333;
            border-radius: 10px;
            color: #ffffff;
            font-size: 15px;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 12px;
            transition: border-color 0.2s ease;
        }

        .hero-note-textarea:focus {
            outline: none;
            border-color: rgba(59, 130, 246, 0.5);
        }

        .hero-note-textarea::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .hero-note-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .hero-note-btn {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .hero-note-btn-cancel {
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .hero-note-btn-cancel:hover {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
        }

        .hero-note-btn-save {
            background: rgba(59, 130, 246, 0.9);
            color: white;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .hero-note-btn-save:hover {
            background: rgba(59, 130, 246, 1);
        }

        .hero-note-btn-save.saved {
            background: rgba(34, 197, 94, 0.9);
            color: white;
            cursor: default;
        }

        .hero-note-btn-save.saved:hover {
            background: rgba(34, 197, 94, 0.9);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span class="broken-o">
                    <svg viewBox="0 0 42 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <mask id="slitMask">
                                <rect width="42" height="48" fill="white"/>
                                <line x1="25" y1="20" x2="33" y2="8" stroke="black" stroke-width="5" stroke-linecap="round"/>
                            </mask>
                        </defs>
                        <circle cx="21" cy="24" r="18" stroke="white" stroke-width="6" fill="none" mask="url(#slitMask)"/>
                    </svg>
                </span>
                <span>utDials</span>
            </h1>
        </div>

        <div id="loginScreen" class="card">
            <div class="login-container">
                <h2>Welcome Back</h2>
                <p>Connect your Salesforce account to start dialing</p>
                <button onclick="loginToSalesforce()" class="btn btn-primary">Connect to Salesforce</button>
            </div>
        </div>

        <div id="dashboardScreen" class="card" style="display: none;">
            <div id="errorMessage"></div>
            <div id="successMessage"></div>

            <div class="user-info">
                <div class="user-details">
                    <h3 id="userName">Loading...</h3>
                    <p id="userOrg">Connecting to Salesforce...</p>
                </div>
                <button onclick="logout()" class="btn btn-logout">Logout</button>
            </div>

            <div class="analytics-section" id="analyticsSection">
                <div class="analytics-header" onclick="toggleAnalytics()">
                    <h3>Session Analytics</h3>
                    <svg class="analytics-chevron" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </div>
                
                <div class="analytics-content">
                    <div class="analytics-stats-grid">
                        <div class="analytics-stat-card">
                            <div class="analytics-stat-label">Total Calls Today</div>
                            <div class="analytics-stat-value" id="statTotalCalls">0</div>
                        </div>
                        <div class="analytics-stat-card">
                            <div class="analytics-stat-label">Connects</div>
                            <div class="analytics-stat-value" id="statConnects">0</div>
                        </div>
                        <div class="analytics-stat-card">
                            <div class="analytics-stat-label">Talk Time</div>
                            <div class="analytics-stat-value" id="statTalkTime">0m</div>
                        </div>
                        <div class="analytics-stat-card">
                            <div class="analytics-stat-label">Calls/Hour</div>
                            <div class="analytics-stat-value" id="statCallsPerHour">0</div>
                        </div>
                        <div class="analytics-stat-card">
                            <div class="analytics-stat-label">Machine Rate</div>
                            <div class="analytics-stat-value" id="statMachineRate">0%</div>
                        </div>
                        <div class="analytics-stat-card">
                            <div class="analytics-stat-label">Avg Duration</div>
                            <div class="analytics-stat-value" id="statAvgDuration">0m</div>
                        </div>
                    </div>
                    
                    <div class="session-history">
                        <h4>Recent Sessions</h4>
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Calls</th>
                                    <th>Connects</th>
                                    <th>Duration</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <tr>
                                    <td colspan="4" class="history-empty">No session history yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="controls-section">
                <h3>Dialing Parameters</h3>
                
                <div class="form-group">
                    <label for="repPhone">Your Phone Number</label>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="padding: 14px 16px; background: #0a0a0a; border: 1px solid #333333; border-radius: 10px; font-weight: 600; color: #ffffff;">+1</span>
                        <input type="tel" id="repPhone" placeholder="(212) 555-1234" maxlength="14" style="flex: 1;" />
                    </div>
                </div>

                <div class="form-group">
                    <label for="teamSelect">Team</label>
                    <select id="teamSelect">
                        <option value="">Select team...</option>
                        <option value="A">Team A</option>
                        <option value="B">Team B</option>
                        <option value="C">Team C</option>
                        <option value="D">Team D</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="regionSelect">Region</label>
                    <select id="regionSelect">
                        <option value="">Select region...</option>
                        <option value="Northeast">Northeast</option>
                        <option value="Southwest">Southwest</option>
                        <option value="Southeast">Southeast</option>
                        <option value="Midwest">Midwest</option>
                    </select>
                </div>

                <div class="call-race-container" id="callRaceContainer">
                    <div class="call-race-grid" id="callRaceGrid">
                        <!-- Race cards will be inserted here -->
                    </div>
                </div>

                <div style="text-align: center; padding: 40px 0 20px; display: flex; flex-direction: column; align-items: center;">
                    <div class="status-indicator idle" id="dialerStatus">
                        <span class="status-dot"></span>
                        <span id="statusText">System Ready</span>
                    </div>
                    <br>
                    <div class="button-group">
                        <button id="startButton" onclick="startDialing()" class="btn btn-control" disabled>
                            Start Dialing
                        </button>
                        <button id="stopButton" onclick="stopDialing()" class="btn btn-control btn-stop" style="display: none;">
                            Stop Dialing
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hero Card for Inbound Calls -->
    <div id="heroCardContainer" class="hero-card-container">
        <div class="hero-card">
            <div class="hero-card-badge">
                <span>üìû</span>
                <span>INCOMING CALL</span>
            </div>
            
            <div class="hero-card-content">
                <div class="hero-card-name" id="heroCardName">Loading...</div>
                
                <div class="hero-card-info-grid">
                    <div class="hero-card-info-item">
                        <div class="hero-card-info-label">Company</div>
                        <div class="hero-card-info-value" id="heroCardCompany">-</div>
                    </div>
                    <div class="hero-card-info-item">
                        <div class="hero-card-info-label">Phone Number</div>
                        <div class="hero-card-info-value" id="heroCardPhone">-</div>
                    </div>
                    <div class="hero-card-info-item">
                        <div class="hero-card-info-label">Region & Team</div>
                        <div class="hero-card-info-value" id="heroCardRegionTeam">-</div>
                    </div>
                    <div class="hero-card-info-item">
                        <div class="hero-card-info-label">Licenses</div>
                        <div class="hero-card-info-value" id="heroCardLicenses">-</div>
                    </div>
                    <div class="hero-card-info-item">
                        <div class="hero-card-info-label">Years at Firm</div>
                        <div class="hero-card-info-value" id="heroCardYears">-</div>
                    </div>
                </div>

                <div class="hero-card-note-compartment" id="heroNoteCompartment">
                    <div class="hero-note-header">
                        <span>üìù</span>
                        <span>Call Notes</span>
                    </div>
                    <textarea 
                        class="hero-note-textarea" 
                        placeholder="Type your notes here..."
                        id="heroNoteText"
                    ></textarea>
                    <div class="hero-note-actions">
                        <button class="hero-note-btn hero-note-btn-cancel" onclick="toggleHeroNote()">Cancel</button>
                        <button class="hero-note-btn hero-note-btn-save" id="heroNoteSaveBtn" onclick="saveHeroNote()">Save</button>
                    </div>
                </div>

                <div class="hero-card-actions">
                    <button class="hero-card-btn hero-card-btn-dismiss" onclick="dismissHeroCard()">
                        <span>‚úï</span>
                        <span>Dismiss</span>
                    </button>
                    <button class="hero-card-btn hero-card-btn-note" onclick="toggleHeroNote()">
                        <span>üìù</span>
                        <span>Add Note</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const N8N_WEBHOOK_BASE = 'https://commacashing.app.n8n.cloud/webhook';
        const SALESFORCE_CONFIG = {
            clientId: '3MVG9HtWXcDGV.nHzF1EzyN.bUajy5rX.YWM11RQGgy_mRqB4oxWWkvtCN2eh5gRZPENJUZjaKqyyDUo0kfvR',
            redirectUri: 'https://fabulous-hamster-abc51c.netlify.app/oauth/callback',
            authUrl: 'https://login.salesforce.com/services/oauth2/authorize',
            scope: 'id api refresh_token'
        };

        const SUPABASE_URL = 'https://ceuiturkokdytamvjcet.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNldWl0dXJrb2tkeXRhbXZqY2V0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4ODg2ODYsImV4cCI6MjA4MjQ2NDY4Nn0.mXyNlwwRldt-k4iTzUWxPsXkfRJ0uZo4WxJk-buCaHo';
        let supabaseClient = null;
        
        if (SUPABASE_URL !== 'YOUR_SUPABASE_URL' && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY') {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }

        let isDialing = false;
        let accessToken = null;
        let instanceUrl = null;
        let sessionId = null;
        let supabaseSubscription = null;
        let currentBatchContacts = new Map();
        let hasUnsavedNotes = false;
        let currentNoteCallSid = null;
        let currentHeroCallSid = null;
        let currentHeroContact = null;

        let currentSessionStats = {
            sessionId: null,
            startTime: null,
            totalCalls: 0,
            connects: 0,
            machines: 0,
            humanAnsweredTime: null,
            callDurations: []
        };

        function toggleAnalytics() {
            const section = document.getElementById('analyticsSection');
            section.classList.toggle('expanded');
        }

        function updateStatsDisplay() {
            document.getElementById('statTotalCalls').textContent = currentSessionStats.totalCalls;
            document.getElementById('statConnects').textContent = currentSessionStats.connects;
            
            const totalMinutes = Math.round(
                currentSessionStats.callDurations.reduce((sum, dur) => sum + dur, 0) / 60
            );
            document.getElementById('statTalkTime').textContent = totalMinutes + 'm';
            
            if (currentSessionStats.startTime) {
                const hoursElapsed = (Date.now() - currentSessionStats.startTime) / 3600000;
                const callsPerHour = hoursElapsed > 0 
                    ? Math.round(currentSessionStats.totalCalls / hoursElapsed)
                    : 0;
                document.getElementById('statCallsPerHour').textContent = callsPerHour;
            }
            
            const machineRate = currentSessionStats.totalCalls > 0
                ? Math.round((currentSessionStats.machines / currentSessionStats.totalCalls) * 100)
                : 0;
            document.getElementById('statMachineRate').textContent = machineRate + '%';
            
            if (currentSessionStats.callDurations.length > 0) {
                const avgSeconds = currentSessionStats.callDurations.reduce((sum, dur) => sum + dur, 0) / currentSessionStats.callDurations.length;
                const avgMinutes = avgSeconds / 60;
                
                if (avgMinutes < 1) {
                    document.getElementById('statAvgDuration').textContent = Math.round(avgSeconds) + 's';
                } else {
                    document.getElementById('statAvgDuration').textContent = Math.round(avgMinutes) + 'm';
                }
            } else {
                document.getElementById('statAvgDuration').textContent = '0s';
            }
            
            localStorage.setItem('dailyStats', JSON.stringify({
                totalCalls: currentSessionStats.totalCalls,
                connects: currentSessionStats.connects,
                machines: currentSessionStats.machines,
                callDurations: currentSessionStats.callDurations,
                startTime: currentSessionStats.startTime
            }));
        }

        function saveSessionToHistory() {
            if (!currentSessionStats.sessionId) return;
            
            const sessions = JSON.parse(localStorage.getItem('sessionHistory') || '[]');
            const sessionData = {
                sessionId: currentSessionStats.sessionId,
                startTime: currentSessionStats.startTime,
                endTime: Date.now(),
                totalCalls: currentSessionStats.totalCalls,
                connects: currentSessionStats.connects,
                duration: Math.round((Date.now() - currentSessionStats.startTime) / 60000)
            };
            
            sessions.unshift(sessionData);
            if (sessions.length > 10) sessions.pop();
            localStorage.setItem('sessionHistory', JSON.stringify(sessions));
            loadSessionHistory();
        }

        function loadSessionHistory() {
            const sessions = JSON.parse(localStorage.getItem('sessionHistory') || '[]');
            const tbody = document.getElementById('historyTableBody');
            
            if (sessions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="history-empty">No session history yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = sessions.slice(0, 5).map(session => {
                const date = new Date(session.startTime);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                return `<tr><td>${dateStr}</td><td>${session.totalCalls}</td><td>${session.connects}</td><td>${session.duration}m</td></tr>`;
            }).join('');
        }

        function resetSessionStats() {
            currentSessionStats = {
                sessionId: null,
                startTime: null,
                totalCalls: 0,
                connects: 0,
                machines: 0,
                humanAnsweredTime: null,
                callDurations: []
            };
            updateStatsDisplay();
        }

        function checkFormValid() {
            const repPhone = '+1' + document.getElementById('repPhone').value.replace(/\D/g, '');
            const team = document.getElementById('teamSelect').value;
            const region = document.getElementById('regionSelect').value;
            
            if (repPhone.length === 12 && !supabaseSubscription) {
                subscribeForInbound();
            }
            
            document.getElementById('startButton').disabled = !(repPhone && team && region) || isDialing;
        }

        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return btoa(String.fromCharCode.apply(null, array)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        async function generateCodeChallenge(verifier) {
            const data = new TextEncoder().encode(verifier);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, new Uint8Array(hash))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        async function loginToSalesforce() {
            const codeVerifier = generateCodeVerifier();
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            sessionStorage.setItem('pkce_code_verifier', codeVerifier);
            const authParams = new URLSearchParams({
                response_type: 'code',
                client_id: SALESFORCE_CONFIG.clientId,
                redirect_uri: SALESFORCE_CONFIG.redirectUri,
                scope: SALESFORCE_CONFIG.scope,
                code_challenge: codeChallenge,
                code_challenge_method: 'S256'
            });
            window.location.href = `${SALESFORCE_CONFIG.authUrl}?${authParams}`;
        }

        async function handleOAuthCallback(code) {
            try {
                const response = await fetch('/.netlify/functions/token-exchange', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code: code,
                        code_verifier: sessionStorage.getItem('pkce_code_verifier'),
                        redirect_uri: SALESFORCE_CONFIG.redirectUri
                    })
                });
                const data = await response.json();
                accessToken = data.access_token;
                instanceUrl = data.instance_url;
                localStorage.setItem('sf_access_token', accessToken);
                localStorage.setItem('sf_instance_url', instanceUrl);
                sessionStorage.removeItem('pkce_code_verifier');
                window.history.replaceState({}, document.title, window.location.pathname);
                await loadUserInfo();
            } catch (error) {
                showError(`OAuth Error: ${error.message}`);
            }
        }

        function loadUserSession() {
            accessToken = localStorage.getItem('sf_access_token');
            instanceUrl = localStorage.getItem('sf_instance_url');
            if (accessToken && instanceUrl) loadUserInfo();
        }

        async function loadUserInfo() {
            try {
                const response = await fetch('/.netlify/functions/userinfo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ access_token: accessToken, instance_url: instanceUrl })
                });
                const userInfo = await response.json();
                document.getElementById('userName').textContent = userInfo.name || 'User';
                document.getElementById('userOrg').textContent = userInfo.organization_id || 'Salesforce Org';
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboardScreen').style.display = 'block';
                showSuccess('Successfully connected to Salesforce!');
            } catch (error) {
                showError(`Failed to load user info: ${error.message}`);
                logout();
            }
        }

        function logout() {
            localStorage.clear();
            unsubscribeFromSupabase();
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('dashboardScreen').style.display = 'none';
        }

        function subscribeToSupabase() {
            if (!supabaseClient) return;
            const repPhone = '+1' + document.getElementById('repPhone').value.replace(/\D/g, '');
            
            supabaseSubscription = supabaseClient.channel('dialer_status')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'dialer_status', 
                        filter: `session_id=eq.${sessionId}` 
                    },
                    (payload) => { 
                        handleStatusUpdate(payload.new); 
                    }
                ).subscribe();
        }
        
        function subscribeForInbound() {
            const repPhone = '+1' + document.getElementById('repPhone').value.replace(/\D/g, '');
            
            supabaseSubscription = supabaseClient.channel('inbound_dialer')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'dialer_status', 
                        filter: `rep_phone=eq.${repPhone.replace('+1', ' 1')}` 
                    },
                    (payload) => { 
                        handleStatusUpdate(payload.new); 
                    }
                ).subscribe();
        }
        
        function unsubscribeFromSupabase() {
            if (supabaseSubscription && supabaseClient) {
                supabaseClient.removeChannel(supabaseSubscription);
                supabaseSubscription = null;
            }
        }

        function handleStatusUpdate(data) {
            const status = data.event_type;
            
            if (status === 'workflow_started') {
                currentSessionStats.sessionId = data.session_id;
                if (!currentSessionStats.startTime) {
                    currentSessionStats.startTime = new Date(data.created_at).getTime();
                }
                updateStatsDisplay();
            } 
            else if (status === 'call_initiated') {
                currentSessionStats.totalCalls++;
                
                const contact = {
                    name: data.contact_name,
                    company: data.contact_company,
                    phone: data.contact_phone,
                    region: data.contact_region,
                    team: data.contact_team,
                    licenses: data.licenses,
                    years_at_firm: data.years_at_firm,
                    call_sid: data.call_sid,
                    status: 'ringing'
                };
                
                currentBatchContacts.set(data.call_sid, contact);
                
                const index = currentBatchContacts.size - 1;
                populateRaceCard(data.call_sid, contact, index);
                
                updateStatsDisplay();
            }
            else if (status === 'machine_detected') {
                currentSessionStats.machines++;
                
                const contact = currentBatchContacts.get(data.call_sid);
                if (contact) {
                    contact.status = 'machine';
                    updateRaceCard(data.call_sid, 'machine');
                }
                
                updateStatsDisplay();
            }
            else if (status === 'call_busy') {
                const contact = currentBatchContacts.get(data.call_sid);
                if (contact) {
                    contact.status = 'busy';
                    contact.busyType = 'call_busy';
                    updateRaceCard(data.call_sid, 'busy', 'call_busy');
                }
            }
            else if (status === 'call_failed') {
                const contact = currentBatchContacts.get(data.call_sid);
                if (contact) {
                    contact.status = 'busy';
                    contact.busyType = 'call_failed';
                    updateRaceCard(data.call_sid, 'busy', 'call_failed');
                }
            }
            else if (status === 'call_no_answer') {
                const contact = currentBatchContacts.get(data.call_sid);
                if (contact) {
                    contact.status = 'busy';
                    contact.busyType = 'call_no_answer';
                    updateRaceCard(data.call_sid, 'busy', 'call_no_answer');
                }
            }
            else if (status === 'call_canceled') {
                const contact = currentBatchContacts.get(data.call_sid);
                if (contact) {
                    contact.status = 'busy';
                    contact.busyType = 'call_canceled';
                    updateRaceCard(data.call_sid, 'busy', 'call_canceled');
                }
            }
            else if (status === 'human_answered' || status === 'inbound_call') {
                currentSessionStats.connects++;
                currentSessionStats.humanAnsweredTime = new Date(data.created_at).getTime();
                
                if (status === 'inbound_call') {
                    // Show hero card for inbound calls
                    showHeroCard(data);
                    
                    // Clear race cards if any
                    document.getElementById('callRaceContainer').classList.remove('active');
                    document.getElementById('callRaceGrid').innerHTML = '';
                    currentBatchContacts.clear();
                } else {
                    // Handle outbound human answer
                    updateRaceCard(data.call_sid, 'human');
                    
                    const contact = currentBatchContacts.get(data.call_sid);
                    if (contact) {
                        contact.status = 'human';
                    }
                }
                
                // Reset to ready state when human answers
                isDialing = false;
                unsubscribeFromSupabase();
                document.getElementById('stopButton').style.display = 'none';
                document.getElementById('startButton').style.display = 'inline-block';
                document.getElementById('repPhone').disabled = false;
                document.getElementById('teamSelect').disabled = false;
                document.getElementById('regionSelect').disabled = false;
                updateStatus('on-call', 'On Call');
                checkFormValid();
                
                updateStatsDisplay();
            }
            else if (status === 'call_completed') {
                if (currentSessionStats.humanAnsweredTime) {
                    const duration = (new Date(data.created_at).getTime() - currentSessionStats.humanAnsweredTime) / 1000;
                    if (duration > 0 && duration < 3600) {
                        currentSessionStats.callDurations.push(duration);
                    }
                    currentSessionStats.humanAnsweredTime = null;
                }
                updateStatsDisplay();
            }
            else if (status === 'workflow_complete' || status === 'batches_complete') {
                saveSessionToHistory();
                updateStatsDisplay();
            }
        }

        async function startDialing() {
            const repPhone = '+1' + document.getElementById('repPhone').value.replace(/\D/g, '');
            const team = document.getElementById('teamSelect').value;
            const region = document.getElementById('regionSelect').value;

            // Check for unsaved notes before starting new session
            if (!checkUnsavedNotes()) {
                return; // User cancelled, don't start new session
            }

            try {
                isDialing = true;
                sessionId = 'session_' + Date.now();

                // Clear previous cards and reset
                currentBatchContacts.clear();
                document.getElementById('callRaceGrid').innerHTML = '';
                hasUnsavedNotes = false;
                currentNoteCallSid = null;

                document.getElementById('startButton').style.display = 'none';
                document.getElementById('stopButton').style.display = 'inline-block';
                document.getElementById('repPhone').disabled = true;
                document.getElementById('teamSelect').disabled = true;
                document.getElementById('regionSelect').disabled = true;
                
                updateStatus('dialing', 'Dialing Active');
                showEmptyRaceCards();
                subscribeToSupabase();

                await fetch(`${N8N_WEBHOOK_BASE}/start-dialing`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'start',
                        session_id: sessionId,
                        rep_phone: repPhone,
                        team: team,
                        region: region,
                        access_token: accessToken,
                        instance_url: instanceUrl
                    })
                });

                localStorage.setItem('current_rep_phone', repPhone);
                showSuccess(`Dialing started for Team ${team} in ${region} region`);
            } catch (error) {
                showError(`Failed to start dialing: ${error.message}`);
                resetDialingState();
            }
        }

        async function stopDialing() {
            try {
                const repPhone = localStorage.getItem('current_rep_phone');
                await fetch(`${N8N_WEBHOOK_BASE}/stop-dialing`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'stop', 
                        session_id: sessionId,
                        rep_phone: repPhone
                    })
                });
                
                // Clear race cards
                document.getElementById('callRaceContainer').classList.remove('active');
                document.getElementById('callRaceGrid').innerHTML = '';
                currentBatchContacts.clear();
                
                // Reset to ready state - same as when human answers
                isDialing = false;
                unsubscribeFromSupabase();
                document.getElementById('stopButton').style.display = 'none';
                document.getElementById('startButton').style.display = 'inline-block';
                document.getElementById('repPhone').disabled = false;
                document.getElementById('teamSelect').disabled = false;
                document.getElementById('regionSelect').disabled = false;
                updateStatus('idle', 'System Ready');
                checkFormValid();
                
                showSuccess('Dialing stopped');
            } catch (error) {
                showError(`Failed to stop: ${error.message}`);
                // Still reset the state even if the API call fails
                document.getElementById('callRaceContainer').classList.remove('active');
                document.getElementById('callRaceGrid').innerHTML = '';
                currentBatchContacts.clear();
                isDialing = false;
                unsubscribeFromSupabase();
                document.getElementById('stopButton').style.display = 'none';
                document.getElementById('startButton').style.display = 'inline-block';
                document.getElementById('repPhone').disabled = false;
                document.getElementById('teamSelect').disabled = false;
                document.getElementById('regionSelect').disabled = false;
                updateStatus('idle', 'System Ready');
                checkFormValid();
            }
        }

        function resetDialingState() {
            isDialing = false;
            unsubscribeFromSupabase();
            document.getElementById('startButton').style.display = 'inline-block';
            document.getElementById('stopButton').style.display = 'none';
            document.getElementById('repPhone').disabled = false;
            document.getElementById('teamSelect').disabled = false;
            document.getElementById('regionSelect').disabled = false;
            updateStatus('idle', 'System Ready');
            checkFormValid();
        }

        function updateStatus(state, text) {
            document.getElementById('dialerStatus').className = `status-indicator ${state}`;
            document.getElementById('statusText').textContent = text;
        }

        function closeRaceAndReset() {
            document.getElementById('callRaceContainer').classList.remove('active');
            document.getElementById('callRaceGrid').innerHTML = '';
            currentBatchContacts.clear();
            resetDialingState();
        }

        function showEmptyRaceCards() {
            const container = document.getElementById('callRaceContainer');
            const grid = document.getElementById('callRaceGrid');
            
            grid.innerHTML = '';
            
            for (let i = 0; i < 3; i++) {
                const card = document.createElement('div');
                card.className = 'race-card dialing-placeholder';
                card.id = `race-card-placeholder-${i}`;
                
                card.innerHTML = `
                    <div class="race-card-status">
                        <span class="race-status-icon">‚è≥</span>
                        <span>Dialing...</span>
                    </div>
                    <div class="race-card-name">Searching for contact</div>
                    <div class="race-card-info">Preparing call ${i + 1}</div>
                `;
                
                grid.appendChild(card);
            }
            
            container.classList.add('active');
        }
        
        function populateRaceCard(callSid, contact, index) {
            const placeholder = document.getElementById(`race-card-placeholder-${index}`);
            if (!placeholder) return;
            
            placeholder.id = `race-card-${callSid}`;
            placeholder.className = 'race-card ringing';
            placeholder.innerHTML = `
                <div class="race-card-status">
                    <span class="race-status-icon">üìû</span>
                    <span>Ringing...</span>
                </div>
                <div class="race-card-name">${contact.name}</div>
                <div class="race-card-info"><strong>${contact.company || 'No company'}</strong></div>
                <div class="race-card-info">${contact.phone || 'No phone'}</div>
                <div class="race-card-info">Region: ${contact.region || '-'} | Team: ${contact.team || '-'}</div>
                <div class="race-card-info">Licenses: ${contact.licenses || '-'}</div>
                <div class="race-card-info">Years: ${contact.years_at_firm || '-'}</div>
            `;
        }

        function updateRaceCard(callSid, status, busyType = null) {
            const card = document.getElementById(`race-card-${callSid}`);
            if (!card) return;
            
            card.classList.remove('ringing', 'human', 'machine', 'busy', 'ended');
            
            if (status === 'human') {
                card.classList.add('human');
                
                const winnerBadge = document.createElement('div');
                winnerBadge.className = 'race-winner-badge';
                winnerBadge.textContent = 'WINNER';
                card.appendChild(winnerBadge);

                const noteBtn = document.createElement('button');
                noteBtn.className = 'race-note-btn';
                noteBtn.textContent = 'üìù';
                noteBtn.onclick = (e) => {
                    e.stopPropagation();
                    toggleNoteCompartment(callSid);
                };
                card.appendChild(noteBtn);

                const contact = currentBatchContacts.get(callSid);
                const noteCompartment = document.createElement('div');
                noteCompartment.className = 'note-compartment';
                noteCompartment.id = `note-compartment-${callSid}`;
                noteCompartment.innerHTML = `
                    <div class="note-compartment-header">
                        Call Notes
                    </div>
                    <div class="note-compartment-subheader">
                        ${contact?.name || 'Contact'}
                    </div>
                    <textarea 
                        class="note-textarea" 
                        placeholder="Type your notes here..."
                        id="note-text-${callSid}"
                        oninput="markNoteAsUnsaved('${callSid}')"
                    ></textarea>
                    <div class="note-actions">
                        <button class="note-btn note-btn-cancel" onclick="toggleNoteCompartment('${callSid}')">Cancel</button>
                        <button class="note-btn note-btn-save" id="note-save-btn-${callSid}" onclick="saveNoteToSalesforce('${callSid}')">Save</button>
                    </div>
                `;
                card.appendChild(noteCompartment);
                
                card.querySelector('.race-card-status').innerHTML = `
                    <span class="race-status-icon">‚úì</span>
                    <span>Human Answered</span>
                `;
                
                currentBatchContacts.forEach((contact, sid) => {
                    if (sid !== callSid && contact.status === 'ringing') {
                        const otherCard = document.getElementById(`race-card-${sid}`);
                        if (otherCard) {
                            otherCard.classList.remove('ringing');
                            otherCard.classList.add('ended');
                            otherCard.querySelector('.race-card-status').innerHTML = `
                                <span class="race-status-icon">‚úï</span>
                                <span>Call Ended</span>
                            `;
                        }
                    }
                });
            } 
            else if (status === 'machine') {
                card.classList.add('machine');
                card.querySelector('.race-card-status').innerHTML = `
                    <span class="race-status-icon">ü§ñ</span>
                    <span>Voicemail</span>
                `;
            }
            else if (status === 'busy') {
                card.classList.add('busy');
                let icon = 'üö´';
                let text = 'Call Busy';
                
                if (busyType === 'call_busy') {
                    icon = 'üåô';
                    text = 'Call Busy';
                } else if (busyType === 'call_failed') {
                    icon = '‚ö†Ô∏è';
                    text = 'Call Failed';
                } else if (busyType === 'call_no_answer') {
                    icon = '‚è±Ô∏è';
                    text = 'No Answer';
                } else if (busyType === 'call_canceled') {
                    icon = 'üö´';
                    text = 'Call Canceled';
                }
                
                card.querySelector('.race-card-status').innerHTML = `
                    <span class="race-status-icon">${icon}</span>
                    <span>${text}</span>
                `;
            }
        }

        function toggleNoteCompartment(callSid) {
            const compartment = document.getElementById(`note-compartment-${callSid}`);
            if (compartment) {
                compartment.classList.toggle('open');
            }
        }

        function markNoteAsUnsaved(callSid) {
            const noteText = document.getElementById(`note-text-${callSid}`).value.trim();
            const saveBtn = document.getElementById(`note-save-btn-${callSid}`);
            
            if (noteText) {
                hasUnsavedNotes = true;
                currentNoteCallSid = callSid;
                
                // If button was previously "Saved", revert it back to "Save"
                if (saveBtn && saveBtn.classList.contains('saved')) {
                    saveBtn.classList.remove('saved');
                    saveBtn.textContent = 'Save';
                    saveBtn.disabled = false;
                }
            } else if (!noteText) {
                hasUnsavedNotes = false;
                currentNoteCallSid = null;
            }
        }

        function checkUnsavedNotes() {
            if (hasUnsavedNotes && currentNoteCallSid) {
                const noteText = document.getElementById(`note-text-${currentNoteCallSid}`)?.value.trim();
                const saveBtn = document.getElementById(`note-save-btn-${currentNoteCallSid}`);
                
                if (noteText && saveBtn && !saveBtn.classList.contains('saved')) {
                    return confirm('You have unsaved notes. Are you sure you want to start a new session? Your notes will be lost.');
                }
            }
            return true;
        }

        async function saveNoteToSalesforce(callSid) {
            const noteText = document.getElementById(`note-text-${callSid}`).value.trim();
            
            if (!noteText) {
                showError('Please enter a note before saving.');
                return;
            }

            const contact = currentBatchContacts.get(callSid);
            if (!contact) {
                showError('Contact information not found.');
                return;
            }

            const saveBtn = document.getElementById(`note-save-btn-${callSid}`);
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                // Call your n8n webhook or Salesforce API to save the note
                const response = await fetch(`${N8N_WEBHOOK_BASE}/save-note`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        call_sid: callSid,
                        contact_name: contact.name,
                        contact_phone: contact.phone,
                        note: noteText,
                        access_token: accessToken,
                        instance_url: instanceUrl
                    })
                });

                if (response.ok) {
                    showSuccess('Note saved to Salesforce!');
                    saveBtn.textContent = 'Saved';
                    saveBtn.classList.add('saved');
                    saveBtn.disabled = true;
                    hasUnsavedNotes = false;
                    currentNoteCallSid = null;
                } else {
                    showError('Failed to save note to Salesforce.');
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save';
                }
            } catch (error) {
                showError(`Error saving note: ${error.message}`);
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save';
            }
        }

        function showError(message) {
            document.getElementById('errorMessage').innerHTML = `<div class="error">${message}</div>`;
        }

        function showSuccess(message) {
            document.getElementById('successMessage').innerHTML = `<div class="success">${message}</div>`;
            setTimeout(() => { document.getElementById('successMessage').innerHTML = ''; }, 3000);
        }

        // Hero Card Functions
        function showHeroCard(data) {
            currentHeroCallSid = data.call_sid;
            currentHeroContact = {
                name: data.contact_name,
                company: data.contact_company,
                phone: data.contact_phone,
                region: data.contact_region,
                team: data.contact_team,
                licenses: data.licenses,
                years_at_firm: data.years_at_firm
            };

            document.getElementById('heroCardName').textContent = data.contact_name || 'Unknown Caller';
            document.getElementById('heroCardCompany').textContent = data.contact_company || '-';
            document.getElementById('heroCardPhone').textContent = data.contact_phone || '-';
            document.getElementById('heroCardRegionTeam').textContent = 
                `${data.contact_region || '-'} ‚Ä¢ ${data.contact_team || '-'}`;
            document.getElementById('heroCardLicenses').textContent = data.licenses || '-';
            document.getElementById('heroCardYears').textContent = data.years_at_firm ? `${data.years_at_firm} years` : '-';

            // Reset note compartment
            document.getElementById('heroNoteCompartment').classList.remove('open');
            document.getElementById('heroNoteText').value = '';
            document.getElementById('heroNoteSaveBtn').classList.remove('saved');
            document.getElementById('heroNoteSaveBtn').textContent = 'Save';

            document.getElementById('heroCardContainer').classList.add('active');
        }

        function dismissHeroCard() {
            document.getElementById('heroCardContainer').classList.remove('active');
            currentHeroCallSid = null;
            currentHeroContact = null;
            
            // Reset to idle state
            updateStatus('idle', 'System Ready');
        }

        function toggleHeroNote() {
            const compartment = document.getElementById('heroNoteCompartment');
            compartment.classList.toggle('open');
        }

        async function saveHeroNote() {
            const noteText = document.getElementById('heroNoteText').value.trim();
            
            if (!noteText) {
                showError('Please enter a note before saving.');
                return;
            }

            if (!currentHeroContact) {
                showError('Contact information not found.');
                return;
            }

            const saveBtn = document.getElementById('heroNoteSaveBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                const response = await fetch(`${N8N_WEBHOOK_BASE}/save-note`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        call_sid: currentHeroCallSid,
                        contact_name: currentHeroContact.name,
                        contact_phone: currentHeroContact.phone,
                        note: noteText,
                        access_token: accessToken,
                        instance_url: instanceUrl
                    })
                });

                if (response.ok) {
                    showSuccess('Note saved to Salesforce!');
                    saveBtn.textContent = 'Saved ‚úì';
                    saveBtn.classList.add('saved');
                    saveBtn.disabled = true;
                } else {
                    showError('Failed to save note to Salesforce.');
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save';
                }
            } catch (error) {
                showError(`Error saving note: ${error.message}`);
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save';
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadSessionHistory();
            
            const lastResetDate = localStorage.getItem('lastStatsReset');
            const today = new Date().toDateString();
            
            if (lastResetDate !== today) {
                resetSessionStats();
                localStorage.setItem('lastStatsReset', today);
            } else {
                const savedStats = localStorage.getItem('dailyStats');
                if (savedStats) {
                    const parsed = JSON.parse(savedStats);
                    currentSessionStats.totalCalls = parsed.totalCalls || 0;
                    currentSessionStats.connects = parsed.connects || 0;
                    currentSessionStats.machines = parsed.machines || 0;
                    currentSessionStats.callDurations = parsed.callDurations || [];
                    currentSessionStats.startTime = parsed.startTime || null;
                    updateStatsDisplay();
                }
            }
            
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            if (code) {
                handleOAuthCallback(code);
            } else if (localStorage.getItem('sf_access_token')) {
                loadUserSession();
            }
            
            document.getElementById('repPhone').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 10) value = value.slice(0, 10);
                if (value.length >= 6) {
                    value = `(${value.slice(0,3)}) ${value.slice(3,6)}-${value.slice(6)}`;
                } else if (value.length >= 3) {
                    value = `(${value.slice(0,3)}) ${value.slice(3)}`;
                }
                e.target.value = value;
                checkFormValid();
            });
            
            document.getElementById('teamSelect').addEventListener('change', checkFormValid);
            document.getElementById('regionSelect').addEventListener('change', checkFormValid);
        });
    </script>
</body>
</html>
