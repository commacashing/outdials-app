<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outdials Power Dialer</title>
    <link rel="icon" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        :root {
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.6);
            --border-color: rgba(255, 255, 255, 0.1);
            --divider-color: rgba(255, 255, 255, 0.1);
        }

        body.light-mode {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --text-primary: #000000;
            --text-secondary: rgba(0, 0, 0, 0.6);
            --border-color: rgba(0, 0, 0, 0.1);
            --divider-color: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background 0.3s ease, color 0.3s ease;
            font-size: 16px;
        }

        /* Top Navigation Bar */
        .top-nav {
            width: 100%;
            padding: 20px 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--divider-color);
        }

        .nav-logo {
    display: flex;
    align-items: center;
    gap: 2px;
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
}

        .broken-o {
            display: inline-block;
            width: 28px;
            height: 32px;
            position: relative;
        }

        .broken-o svg {
            width: 100%;
            height: 100%;
        }

        .broken-o svg circle {
            stroke: var(--text-primary);
        }

        .nav-user {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .user-name {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .user-org {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .theme-toggle {
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: var(--bg-secondary);
        }

        .btn-logout {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-logout:hover {
            background: var(--bg-secondary);
        }

        /* Controls Bar */
        .controls-bar {
            width: 100%;
            padding: 16px 40px;
            display: flex;
            align-items: center;
            gap: 16px;
            border-bottom: 1px solid var(--divider-color);
            background: var(--bg-secondary);
        }

        .control-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            white-space: nowrap;
        }

        .control-input {
            padding: 10px 14px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-weight: 500;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .control-input:focus {
            outline: none;
            border-color: rgba(107, 144, 128, 0.5);
        }

        .control-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        select.control-input {
            cursor: pointer;
            min-width: 140px;
        }

        input[type="tel"].control-input {
            min-width: 160px;
        }

        .phone-wrapper {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .phone-prefix {
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 16px;
        }

        .controls-divider {
            width: 1px;
            height: 32px;
            background: var(--divider-color);
            margin: 0 8px;
        }

        .btn-start {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 10px 32px;
            font-size: 15px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: auto;
        }

        .btn-start:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }

        .btn-start:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .btn-stop {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.3);
            color: rgba(239, 68, 68, 0.9);
        }
        
      .centered-action-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-end;
    gap: 16px;
    min-height: 200px;
    margin-top: auto;
    margin-bottom: 40px;
    padding-bottom: 40px;
    padding-top: 120px;
}

.centered-action-section .status-indicator {
    margin-bottom: 0;
    padding: 8px 20px;  
    font-size: 13px;  
}

.centered-action-section .status-indicator .status-dot {
    width: 6px;  /* ADD THIS LINE */
    height: 6px;  /* ADD THIS LINE */
}
        
.centered-action-section .btn-start {
    font-size: 20px;
    padding: 18px 56px;
    min-width: 220px;
    margin-left: 0;
}
        
        /* Main Content Area */
        .main-content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px 40px 0px 40px;
    display: flex;
    flex-direction: column;
    min-height: auto;  /* ‚úÖ This fixes scrolling */
}

        .main-content-full {
            width: 100%;
            padding: 60px 40px;
        }

        /* Status Indicator */
        .status-section {
            text-align: center;
            margin-bottom: 60px;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
        }

        .status-indicator.dialing .status-dot,
        .status-indicator.on-call .status-dot {
            background: #ef4444;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* Race Cards */
.call-race-container {
    display: block;
    margin-bottom: 20px;
    flex: 0 0 auto;
    min-height: 320px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.call-race-container:not(.active) {
    visibility: hidden;
}

        .call-race-container.active {
            display: block;
        }

        .call-race-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .race-card {
    background: var(--bg-secondary);
    border: 2px solid rgba(255, 255, 255, 0.15);
    border-radius: 16px;
    padding: 24px;
    transition: all 0.4s ease;
    position: relative;
}

body.light-mode .race-card {
    border-color: rgba(0, 0, 0, 0.15);
}

        .race-card.ringing {
            animation: cardPulse 0.8s ease-in-out infinite;
        }

        .race-card.dialing-placeholder {
            animation: dialingShimmer 1.5s ease-in-out infinite;
        }

        @keyframes dialingShimmer {
            0%, 100% { 
                background: rgba(255, 255, 255, 0.05);
                border-color: rgba(255, 255, 255, 0.15);
            }
            50% { 
                background: rgba(255, 255, 255, 0.1);
                border-color: rgba(255, 255, 255, 0.3);
            }
        }

        .race-card.human {
            background: rgba(34, 197, 94, 0.15);
            border-color: rgba(34, 197, 94, 0.5);
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.3);
            animation: none;
            transform: scale(1.05);
        }

        .race-card.machine {
            background: rgba(251, 191, 36, 0.1);
            border-color: rgba(251, 191, 36, 0.3);
            opacity: 0.4;
            animation: none;
        }

        .race-card.busy {
            background: rgba(255, 107, 53, 0.1);
            border-color: rgba(255, 107, 53, 0.3);
            opacity: 0.4;
            animation: none;
        }

        .race-card.ended {
            opacity: 0.3;
            animation: none;
        }

        @keyframes cardPulse {
            0%, 100% { 
                border-color: rgba(255, 255, 255, 0.3);
                box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
            }
            50% { 
                border-color: rgba(255, 255, 255, 0.6);
                box-shadow: 0 0 25px rgba(255, 255, 255, 0.4);
            }
        }

        .race-card-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .race-card.ringing .race-card-status {
            color: rgba(255, 255, 255, 0.7);
        }

        .race-card.dialing-placeholder .race-card-status {
            color: rgba(255, 255, 255, 0.5);
        }

        .race-card.human .race-card-status {
            color: rgba(34, 197, 94, 1);
        }

        .race-card.machine .race-card-status {
            color: rgba(251, 191, 36, 0.9);
        }

        .race-card.busy .race-card-status {
            color: rgba(255, 107, 53, 0.9);
        }

        .race-card.ended .race-card-status {
            color: rgba(255, 255, 255, 0.4);
        }

        .race-status-icon {
            font-size: 18px;
        }

        .race-card-name {
    color: var(--text-primary);
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 8px;
}

        .race-card.dialing-placeholder .race-card-name {
            opacity: 0.5;
        }

        .race-card.machine .race-card-name,
        .race-card.busy .race-card-name,
        .race-card.ended .race-card-name {
            opacity: 0.6;
        }

        .race-card-info {
    color: var(--text-secondary);
    font-size: 15px;
    margin-bottom: 4px;
}

        .race-card.dialing-placeholder .race-card-info {
            opacity: 0.4;
        }

        .race-card.machine .race-card-info,
        .race-card.busy .race-card-info,
        .race-card.ended .race-card-info {
            opacity: 0.5;
        }

        .race-winner-badge {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(34, 197, 94, 1);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
        }

        .race-note-btn {
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(59, 130, 246, 0.9);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            transition: all 0.2s ease;
        }

        .race-note-btn:hover {
            background: rgba(59, 130, 246, 1);
            transform: translateX(-50%) scale(1.1);
        }

        .race-optout-btn {
    position: absolute;
    bottom: -12px;
    right: 12px;
    background: rgba(239, 68, 68, 0.9);
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: white;
    z-index: 10;
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    transition: all 0.2s ease;
}

.race-optout-btn:hover {
    background: rgba(239, 68, 68, 1);
    transform: scale(1.1);
}

.race-disposition-btn {
    position: absolute;
    bottom: -12px;
    left: 12px;
    background: rgba(147, 51, 234, 0.9);
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: white;
    z-index: 10;
    box-shadow: 0 4px 12px rgba(147, 51, 234, 0.4);
    transition: all 0.2s ease;
}

.race-disposition-btn:hover {
    background: rgba(147, 51, 234, 1);
    transform: scale(1.1);
}

.disposition-compartment {
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    margin-top: 20px;
    width: 100%;
    background: rgba(26, 26, 26, 0.98);
    border: 1px solid rgba(147, 51, 234, 0.3);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    z-index: 15;
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transition: all 0.3s ease;
}

.disposition-compartment.open {
    max-height: 400px;
    opacity: 1;
}

.disposition-compartment-header {
    color: #ffffff;
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 16px;
}

.disposition-option {
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;
    color: #ffffff;
}

.disposition-option:hover {
    background: rgba(147, 51, 234, 0.2);
    border-color: rgba(147, 51, 234, 0.4);
}

.disposition-option.selected {
    background: rgba(147, 51, 234, 0.3);
    border-color: rgba(147, 51, 234, 0.6);
}
        .note-compartment {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 20px;
            width: 100%;
            background: rgba(26, 26, 26, 0.98);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            z-index: 15;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .note-compartment.open {
            max-height: 400px;
            opacity: 1;
        }

        .note-compartment-header {
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .note-compartment-subheader {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            margin-bottom: 16px;
        }

        .note-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            background: #0a0a0a;
            border: 1px solid #333333;
            border-radius: 8px;
            color: #ffffff;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 12px;
        }

        .note-textarea:focus {
            outline: none;
            border-color: rgba(59, 130, 246, 0.5);
        }

        .note-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .note-btn {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .note-btn-cancel {
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .note-btn-save {
            background: rgba(59, 130, 246, 0.9);
            color: white;
        }

        .note-btn-save.saved {
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.6);
            cursor: default;
        }

        /* Analytics Section */
       .analytics-section {
    width: 100%;
    border-bottom: 1px solid var(--divider-color);
    padding-bottom: 20px;
}

       .analytics-header {
    padding: 20px 0;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    transition: all 0.2s ease;
    position: relative;
}
        .download-btn-wrapper {
    position: absolute;
    right: 0;
}

        .analytics-header h3 {
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .analytics-chevron {
            width: 16px;
            height: 16px;
            stroke: var(--text-secondary);
            transition: transform 0.3s ease;
        }

       .analytics-section.expanded .analytics-chevron {
            transform: rotate(180deg);
        }

        .download-btn-wrapper {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .analytics-section.expanded .download-btn-wrapper {
            opacity: 1;
            visibility: visible;
        }
        .analytics-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .analytics-section.expanded .analytics-content {
            max-height: 2000px;
        }

        .analytics-stats-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 20px;
            max-width: 1200px;
            margin: 20px auto;
        }

        .analytics-stat-card {
            text-align: center;
            padding: 20px;
        }

        .analytics-stat-label {
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .analytics-stat-value {
            color: var(--text-primary);
            font-size: 32px;
            font-weight: 700;
        }

        /* Hero Card */
        .hero-card-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .hero-card-container.active {
            display: flex;
        }

       .hero-card {
    background: var(--bg-secondary);
    border: 3px solid rgba(34, 197, 94, 0.6);
    border-radius: 24px;
    padding: 48px;
    max-width: 600px;
    width: 100%;
    position: relative;
    box-shadow: 0 0 40px rgba(34, 197, 94, 0.4);
    animation: heroCardPulse 2s ease-in-out infinite;
}

        @keyframes heroCardPulse {
            0%, 100% { 
                border-color: rgba(34, 197, 94, 0.6);
                box-shadow: 0 0 40px rgba(34, 197, 94, 0.4);
            }
            50% { 
                border-color: rgba(34, 197, 94, 0.9);
                box-shadow: 0 0 60px rgba(34, 197, 94, 0.6);
            }
        }

        .hero-card-badge {
            position: absolute;
            top: -16px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(34, 197, 94, 1);
            color: white;
            padding: 10px 24px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .hero-card-name {
    color: var(--text-primary);
    font-size: 32px;
    font-weight: 700;
    margin: 24px 0;
    text-align: center;
}

        .hero-card-info-grid {
            display: grid;
            gap: 16px;
            margin-bottom: 32px;
        }

        .hero-card-info-item {
    background: var(--bg-primary);
    padding: 16px 20px;
    border-radius: 12px;
}

        .hero-card-info-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .hero-card-info-value {
    color: var(--text-primary);
    font-size: 16px;
    font-weight: 600;
}

        .hero-card-actions {
    display: flex;
    gap: 20px;
    justify-content: center;
}

.hero-card-btn {
    width: 48px;
    height: 48px;
    font-size: 20px;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.hero-card-btn-dismiss {
    position: absolute;
    top: 16px;
    right: 16px;
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.7);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.hero-card-btn-dismiss:hover {
    background: rgba(255, 255, 255, 0.15);
    transform: scale(1.1);
}

.hero-disposition-btn {
    background: rgba(147, 51, 234, 0.9);
    color: white;
}

.hero-disposition-btn:hover {
    background: rgba(147, 51, 234, 1);
    transform: scale(1.1);
}

.hero-card-btn-note {
    background: rgba(59, 130, 246, 0.9);
    color: white;
}

.hero-card-btn-note:hover {
    background: rgba(59, 130, 246, 1);
    transform: scale(1.1);
}

.hero-card-btn-dnc {
    background: rgba(239, 68, 68, 0.9);
    color: white;
}

.hero-card-btn-dnc:hover {
    background: rgba(239, 68, 68, 1);
    transform: scale(1.1);
}

.hero-disposition-compartment {
    margin-top: 24px;
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transition: all 0.3s ease;
}

.hero-disposition-compartment.open {
    max-height: 400px;
    opacity: 1;
}

        .hero-card-note-compartment {
            margin-top: 24px;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .hero-card-note-compartment.open {
            max-height: 400px;
            opacity: 1;
        }

        .hero-note-textarea {
            width: 100%;
            min-height: 120px;
            padding: 14px;
            background: #0a0a0a;
            border: 1px solid #333333;
            border-radius: 10px;
            color: #ffffff;
            font-size: 15px;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 12px;
        }

        .hero-note-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .hero-note-btn {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .hero-note-btn-save {
            background: rgba(59, 130, 246, 0.9);
            color: white;
        }

        .hero-note-btn-save.saved {
            background: rgba(34, 197, 94, 0.9);
        }

        /* Login Screen */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .login-container {
            text-align: center;
            max-width: 400px;
        }

        .login-container h2 {
    color: var(--text-primary);
    font-size: 32px;
    font-weight: 700;
    margin-bottom: 32px;
}

        .login-container p {
            color: var(--text-secondary);
            font-size: 15px;
            margin-bottom: 32px;
        }

        .btn-primary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 14px 32px;
            font-size: 15px;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }

        /* Messages */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .download-menu {
    position: absolute;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 100;
}

.download-menu-item {
    padding: 10px 20px;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.2s;
}

.download-menu-item:hover {
    background: var(--bg-primary);
}
        
        .error {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ff6b6b;
        }

        .success {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #6bff6b;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .analytics-stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

@media (max-width: 768px) {
    /* Compact top nav - logo + user info + buttons in one row */
    .top-nav {
        padding: 12px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .nav-logo {
        font-size: 18px;
        flex-shrink: 0;
    }

.broken-o {
        width: 20px;
        height: 24px;
    }

    /* User info - centered in controls bar */
    .controls-bar::before {
        content: attr(data-username);
        display: block;
        width: 100%;
        text-align: center;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
        order: -1;
        margin-bottom: 8px;
    }

    /* Hide user info from controls bar - we'll show it differently */
    .controls-bar .control-item:has(.user-name) {
        display: none;
    }

/* Theme toggle - top right corner */
.theme-toggle {
    position: absolute;
    top: 8px;
    right: 16px;
    width: 36px;
    height: 36px;
    font-size: 16px;
    z-index: 100;
}

/* Logout button - full width, centered below user name */
.btn-logout {
    width: calc(100% - 32px);
    margin: 8px 16px;
    padding: 10px 20px;
    font-size: 13px;
    text-align: center;
}

/* Force Team and Region wrapper */
/* Controls bar - phone centered full width, team/region in one row below */
.controls-bar {
    padding: 12px 16px;
    flex-direction: row;  /* CHANGE from column to row */
    flex-wrap: wrap;      /* ADD THIS */
    gap: 12px;
    align-items: stretch;
    justify-content: space-between;  /* ADD THIS */
}

.control-item {
    width: 100%;
    justify-content: center;
}

/* Phone number - centered and full width */
.control-item:has(#repPhone) {
    order: 1;
    justify-content: center;
    width: 100% !important;
}

/* Team and Region container */
.controls-bar {
    display: flex;
    flex-wrap: wrap;
}

/* Team and Region side by side */
.control-item:has(#teamSelect),
.control-item:has(#regionSelect) {
    order: 2;
    width: calc(50% - 6px) !important;  /* 50% minus half the gap */
    flex: 0 0 calc(50% - 6px);
}

.control-item:has(#teamSelect) {
    margin-right: 0;
}

.control-item:has(#regionSelect) {
    margin-left: 0;
}

    .control-label {
        font-size: 10px;
    }

    select.control-input {
        font-size: 12px;
        min-width: auto;
        padding: 8px 10px;
    }

    /* Hide dividers on mobile */
    .controls-divider {
        display: none;
    }

    /* Hide user info from controls bar (it's in top nav now) */
    .controls-bar .control-item:has(.user-name) {
        display: none;
    }

    /* Session Analytics - smaller and compact */
    .analytics-section {
        padding: 12px 16px 12px 16px !important;
    }

    .analytics-header {
        padding: 12px 0;
    }

    .analytics-header h3 {
        font-size: 11px;
    }

    .analytics-stats-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin: 12px auto;
    }

    .analytics-stat-card {
        padding: 10px;
    }

    .analytics-stat-label {
        font-size: 9px;
        margin-bottom: 4px;
    }

    .analytics-stat-value {
        font-size: 18px;
    }

    /* Main content - less padding */
    .main-content {
        padding: 12px 16px 0px 16px;
    }

    /* Race cards - reduce height to make room */
    .call-race-container {
        min-height: 180px;
        margin-bottom: 12px;
    }

    .call-race-grid {
        grid-template-columns: 1fr;
        gap: 12px;
    }

    .race-card {
        padding: 16px;
    }

    .race-card-name {
        font-size: 16px;
    }

    .race-card-info {
        font-size: 13px;
    }

    /* System Ready and Start Dialing - move up and make visible */
    .centered-action-section {
        min-height: 60px;
        padding-top: 20px;
        padding-bottom: 20px;
        margin-bottom: 20px;
        gap: 12px;
    }

    .centered-action-section .status-indicator {
        padding: 6px 16px;
        font-size: 11px;
    }

    .centered-action-section .status-indicator .status-dot {
        width: 5px;
        height: 5px;
    }

    .centered-action-section .btn-start {
        font-size: 16px;
        padding: 14px 40px;
        min-width: 180px;
    }

    /* Mobile-only: Pop up centered on screen */
@media (max-width: 768px) {
    .note-compartment {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        margin-top: 0;
        width: calc(100% - 40px);
        max-width: 500px;
        z-index: 100;
    }
}
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <div class="nav-logo" style="justify-content: center; margin-bottom: 32px;">
    <span class="broken-o">
        <svg viewBox="0 0 42 48" fill="none" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <mask id="slitMask">
                    <rect width="42" height="48" fill="white"/>
                    <line x1="25" y1="20" x2="33" y2="8" stroke="black" stroke-width="5" stroke-linecap="round"/>
                </mask>
            </defs>
            <circle cx="21" cy="24" r="18" stroke="currentColor" stroke-width="6" fill="none" mask="url(#slitMask)"/>
        </svg>
    </span>
    <span>utDials</span>
</div>
            <h2>Welcome Back</h2>
            <button onclick="loginToSalesforce()" class="btn-primary">Connect to Salesforce</button>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardScreen" style="display: none;">
        <!-- Top Navigation -->
<div class="top-nav">
    <div class="nav-logo">
        <span class="broken-o">
            <svg viewBox="0 0 42 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <mask id="slitMask2">
                        <rect width="42" height="48" fill="white"/>
                        <line x1="25" y1="20" x2="33" y2="8" stroke="black" stroke-width="5" stroke-linecap="round"/>
                    </mask>
                </defs>
                <circle cx="21" cy="24" r="18" stroke="currentColor" stroke-width="6" fill="none" mask="url(#slitMask2)"/>
            </svg>
        </span>
        <span>utDials</span>
    </div>
</div>

        <div class="controls-bar">
    <div class="control-item">
        <span class="control-label">Phone</span>
        <div class="phone-wrapper">
            <span class="phone-prefix">+1</span>
            <input type="tel" id="repPhone" class="control-input" placeholder="(212) 555-1234" maxlength="14" />
        </div>
    </div>

    <div class="controls-divider"></div>

    <div class="control-item">
        <span class="control-label">Team</span>
        <select id="teamSelect" class="control-input">
            <option value="">Select team...</option>
            <option value="A">Team A</option>
            <option value="B">Team B</option>
            <option value="C">Team C</option>
            <option value="D">Team D</option>
        </select>
    </div>

    <div class="controls-divider"></div>

    <div class="control-item">
        <span class="control-label">Region</span>
        <select id="regionSelect" class="control-input">
            <option value="">Select region...</option>
            <option value="Northeast">Northeast</option>
            <option value="Southwest">Southwest</option>
            <option value="Southeast">Southeast</option>
            <option value="Midwest">Midwest</option>
        </select>
    </div>

    <div class="controls-divider"></div>

    <div class="control-item" style="margin-left: auto;">
    <div>
        <div class="user-name" id="userName">Loading...</div>
        <div class="user-org" id="userOrg">Connecting...</div>
    </div>
</div>

    <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">üåô</button>
    <button onclick="logout()" class="btn-logout">Logout</button>
</div>
        <div class="analytics-section" id="analyticsSection" style="padding: 20px 40px 0px 40px; border-top: none;">
    <div class="analytics-header" onclick="toggleAnalytics()">
    <h3>Session Analytics</h3>
    <svg class="analytics-chevron" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="6 9 12 15 18 9"></polyline>
    </svg>
    <div class="download-btn-wrapper">
        <button onclick="event.stopPropagation(); showDownloadMenu(event)" style="background: transparent; border: 1px solid var(--border-color); border-radius: 6px; padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 6px; color: var(--text-primary); font-size: 13px; transition: all 0.2s;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 5v13"/>
                <path d="M19 12l-7 7-7-7"/>
                <line x1="5" y1="21" x2="19" y2="21"/>
            </svg>
            <span>Download</span>
        </button>
    </div>
</div>

<div class="analytics-content">
    <div class="analytics-stats-grid">
        <div class="analytics-stat-card">
            <div class="analytics-stat-label">Total Calls</div>
            <div class="analytics-stat-value" id="statTotalCalls">0</div>
        </div>
        <div class="analytics-stat-card">
            <div class="analytics-stat-label">Connects</div>
            <div class="analytics-stat-value" id="statConnects">0</div>
        </div>
        <div class="analytics-stat-card">
            <div class="analytics-stat-label">Talk Time</div>
            <div class="analytics-stat-value" id="statTalkTime">0m</div>
        </div>
        <div class="analytics-stat-card">
            <div class="analytics-stat-label">Calls/Hour</div>
            <div class="analytics-stat-value" id="statCallsPerHour">0</div>
        </div>
        <div class="analytics-stat-card">
            <div class="analytics-stat-label">Machine Rate</div>
            <div class="analytics-stat-value" id="statMachineRate">0%</div>
        </div>
        <div class="analytics-stat-card">
            <div class="analytics-stat-label">Avg Duration</div>
            <div class="analytics-stat-value" id="statAvgDuration">0m</div>
        </div>
    </div>
</div>
        <div class="main-content">
    <div id="errorMessage"></div>
    <div id="successMessage"></div>

    <div class="call-race-container" id="callRaceContainer">
        <div class="call-race-grid" id="callRaceGrid">
        </div>
    </div>

    <div class="centered-action-section" id="centeredActionSection">
        <div class="status-indicator idle" id="dialerStatus">
            <span class="status-dot"></span>
            <span id="statusText">System Ready</span>
        </div>

        <button id="startButton" onclick="startDialing()" class="btn-start" disabled>Start Dialing</button>
        <button id="stopButton" onclick="stopDialing()" class="btn-start btn-stop" style="display: none;">Stop Dialing</button>
    </div>
</div>

    <div id="heroCardContainer" class="hero-card-container">
        <div class="hero-card">
            <div class="hero-card-badge">
                <span>üìû</span>
                <span>INCOMING CALL</span>
            </div>
            
            <div class="hero-card-name" id="heroCardName">Loading...</div>
            
            <div class="hero-card-info-grid">
                <div class="hero-card-info-item">
                    <div class="hero-card-info-label">Company</div>
                    <div class="hero-card-info-value" id="heroCardCompany">-</div>
                </div>
                <div class="hero-card-info-item">
                    <div class="hero-card-info-label">Phone Number</div>
                    <div class="hero-card-info-value" id="heroCardPhone">-</div>
                </div>
                <div class="hero-card-info-item">
                    <div class="hero-card-info-label">Region & Team</div>
                    <div class="hero-card-info-value" id="heroCardRegionTeam">-</div>
                </div>
                <div class="hero-card-info-item">
                    <div class="hero-card-info-label">Licenses</div>
                    <div class="hero-card-info-value" id="heroCardLicenses">-</div>
                </div>
                <div class="hero-card-info-item">
                    <div class="hero-card-info-label">Years at Firm</div>
                    <div class="hero-card-info-value" id="heroCardYears">-</div>
                </div>
            </div>

            <div class="hero-disposition-compartment" id="heroDispositionCompartment">
    <div style="color: #ffffff; font-size: 14px; font-weight: 600; margin-bottom: 16px;">Select Call Outcome</div>
    <div class="disposition-option" onclick="selectHeroDisposition('Interested')">
        ‚úÖ Interested
    </div>
    <div class="disposition-option" onclick="selectHeroDisposition('Not Interested')">
        ‚ùå Not Interested
    </div>
    <div class="disposition-option" onclick="selectHeroDisposition('Callback')">
        üìû Callback Requested
    </div>
    <div class="disposition-option" onclick="selectHeroDisposition('Wrong Number')">
        ‚ùì Wrong Number
    </div>
</div>
            
            <div class="hero-card-note-compartment" id="heroNoteCompartment">
                <div style="color: #ffffff; font-size: 14px; font-weight: 600; margin-bottom: 12px;">üìù Call Notes</div>
                <textarea 
                    class="hero-note-textarea" 
                    placeholder="Type your notes here..."
                    id="heroNoteText"
                    oninput="markHeroNoteAsUnsaved()"
                ></textarea>
                <div class="hero-note-actions">
                    <button class="hero-note-btn" style="background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.6); border: 1px solid rgba(255,255,255,0.15);" onclick="toggleHeroNote()">Cancel</button>
                    <button class="hero-note-btn hero-note-btn-save" id="heroNoteSaveBtn" onclick="saveHeroNote()">Save</button>
                </div>
            </div>

<div class="hero-card-actions">
    <button class="hero-card-btn hero-card-btn-dismiss" onclick="dismissHeroCard()">‚úï</button>

<div class="hero-card-actions">
    <button class="hero-card-btn hero-disposition-btn" onclick="toggleHeroDisposition()">üè∑Ô∏è</button>
    <button class="hero-card-btn hero-card-btn-note" onclick="toggleHeroNote()">üìù</button>
    <button class="hero-card-btn hero-card-btn-dnc" onclick="markHeroOptOut()">üö´</button>
</div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const N8N_WEBHOOK_BASE = 'https://commacashing.app.n8n.cloud/webhook';
        const SALESFORCE_CONFIG = {
            clientId: '3MVG9HtWXcDGV.nHzF1EzyN.bUajy5rX.YWM11RQGgy_mRqB4oxWWkvtCN2eh5gRZPENJUZjaKqyyDUo0kfvR',
            redirectUri: 'https://fabulous-hamster-abc51c.netlify.app/oauth/callback',
            authUrl: 'https://login.salesforce.com/services/oauth2/authorize',
            scope: 'id api refresh_token'
        };

        let supabaseClient = null;

        async function initSupabase() {
            try {
                const response = await fetch('/.netlify/functions/supabase-init', {
                    method: 'POST'
                });
                const { url, key } = await response.json();
                supabaseClient = window.supabase.createClient(url, key);
            } catch (error) {
                console.error('Failed to initialize Supabase:', error);
            }
        }

        let isDialing = false;
        let accessToken = null;
        let instanceUrl = null;
        let sessionId = null;
        let supabaseSubscription = null;
        let currentBatchContacts = new Map();
        let hasUnsavedNotes = false;
        let currentNoteCallSid = null;
        let currentHeroCallSid = null;
        let currentHeroContact = null;
        let autoSaveInterval = null;
        let isAuthenticated = false;
        let inactivityTimer = null;
        let inactivityWarningShown = false;
        let lastActivityTime = Date.now();

        function normalizePhone(phone) {
    if (!phone) return '';
    const digits = phone.replace(/\D/g, '');
    return '+1' + digits.slice(-10);
}

        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function playPhoneRing() {
            playRingTone(0);
            setTimeout(() => playRingTone(0.4), 400);
        }

        function playRingTone(startTime) {
            const now = audioContext.currentTime + startTime;
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(440, now);
            oscillator.frequency.setValueAtTime(480, now + 0.05);
            
            gainNode.gain.setValueAtTime(0.3, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
            
            oscillator.start(now);
            oscillator.stop(now + 0.2);
        }

        function playSuccessChime() {
            const now = audioContext.currentTime;
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(523.25, now);
            oscillator.frequency.exponentialRampToValueAtTime(659.25, now + 0.15);
            
            gainNode.gain.setValueAtTime(0.3, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
            
            oscillator.type = 'sine';
            oscillator.start(now);
            oscillator.stop(now + 0.4);
        }

        let currentSessionStats = {
            sessionId: null,
            startTime: null,
            totalCalls: 0,
            connects: 0,
            machines: 0,
            humanAnsweredTime: null,
            callDurations: []
        };

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const themeToggle = document.getElementById('themeToggle');
            themeToggle.textContent = document.body.classList.contains('light-mode') ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
        }

        function toggleAnalytics() {
            document.getElementById('analyticsSection').classList.toggle('expanded');
        }

function showDownloadMenu(e) {
    e.stopPropagation();
    document.querySelectorAll('.download-menu').forEach(m => m.remove());
    
    const button = e.currentTarget;
    const rect = button.getBoundingClientRect();
    
    const menu = document.createElement('div');
    menu.className = 'download-menu';
    menu.style.position = 'fixed';
    menu.style.top = (rect.bottom + 4) + 'px';
    menu.style.right = (window.innerWidth - rect.right) + 'px';
    
    ['Today', 'Week', 'Month', 'All Time'].forEach(range => {
        const item = document.createElement('div');
        item.className = 'download-menu-item';
        item.textContent = range;
        item.onclick = () => downloadData(range.toLowerCase().replace(' ', '_'));
        menu.appendChild(item);
    });
    
    document.body.appendChild(menu);
    
    setTimeout(() => {
        document.addEventListener('click', () => menu.remove(), { once: true });
    }, 100);
}

async function downloadData(range) {
    const repPhone = normalizePhone(document.getElementById('repPhone').value);
    
    if (!repPhone || repPhone.length !== 12) {
        showError('Please enter your phone number first');
        return;
    }
    
    try {
        const response = await fetch(`${N8N_WEBHOOK_BASE}/export-my-data`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                rep_phone: repPhone,
                date_range: range 
            })
        });
        
        const csv = await response.text();
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `outdials-${range}-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        
        showSuccess('Data downloaded!');
    } catch (error) {
        showError(`Download failed: ${error.message}`);
    }
}
        
        function updateStatsDisplay() {
            document.getElementById('statTotalCalls').textContent = currentSessionStats.totalCalls;
            document.getElementById('statConnects').textContent = currentSessionStats.connects;
            
            const totalMinutes = Math.round(
                currentSessionStats.callDurations.reduce((sum, dur) => sum + dur, 0) / 60
            );
            document.getElementById('statTalkTime').textContent = totalMinutes + 'm';
            
            if (currentSessionStats.startTime) {
                const hoursElapsed = (Date.now() - currentSessionStats.startTime) / 3600000;
                const callsPerHour = hoursElapsed > 0 
                    ? Math.round(currentSessionStats.totalCalls / hoursElapsed)
                    : 0;
                document.getElementById('statCallsPerHour').textContent = callsPerHour;
            }
            
            const machineRate = currentSessionStats.totalCalls > 0
                ? Math.round((currentSessionStats.machines / currentSessionStats.totalCalls) * 100)
                : 0;
            document.getElementById('statMachineRate').textContent = machineRate + '%';
            
            if (currentSessionStats.callDurations.length > 0) {
                const avgSeconds = currentSessionStats.callDurations.reduce((sum, dur) => sum + dur, 0) / currentSessionStats.callDurations.length;
                const avgMinutes = avgSeconds / 60;
                
                if (avgMinutes < 1) {
                    document.getElementById('statAvgDuration').textContent = Math.round(avgSeconds) + 's';
                } else {
                    document.getElementById('statAvgDuration').textContent = Math.round(avgMinutes) + 'm';
                }
            } else {
                document.getElementById('statAvgDuration').textContent = '0s';
            }
            
            localStorage.setItem('dailyStats', JSON.stringify({
                totalCalls: currentSessionStats.totalCalls,
                connects: currentSessionStats.connects,
                machines: currentSessionStats.machines,
                callDurations: currentSessionStats.callDurations,
                startTime: currentSessionStats.startTime
            }));
        }

        function resetSessionStats() {
            currentSessionStats = {
                sessionId: null,
                startTime: null,
                totalCalls: 0,
                connects: 0,
                machines: 0,
                humanAnsweredTime: null,
                callDurations: []
            };
            updateStatsDisplay();
        }

        function checkFormValid() {
            const repPhone = '+1' + document.getElementById('repPhone').value.replace(/\D/g, '');
            const team = document.getElementById('teamSelect').value;
            const region = document.getElementById('regionSelect').value;
            
            if (isAuthenticated && repPhone.length === 12 && !supabaseSubscription) {
                subscribeForInbound();
            }
            
            document.getElementById('startButton').disabled = !(repPhone && team && region) || isDialing;
        }

        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return btoa(String.fromCharCode.apply(null, array)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        async function generateCodeChallenge(verifier) {
            const data = new TextEncoder().encode(verifier);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, new Uint8Array(hash))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        async function loginToSalesforce() {
            const codeVerifier = generateCodeVerifier();
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            sessionStorage.setItem('pkce_code_verifier', codeVerifier);
            const authParams = new URLSearchParams({
                response_type: 'code',
                client_id: SALESFORCE_CONFIG.clientId,
                redirect_uri: SALESFORCE_CONFIG.redirectUri,
                scope: SALESFORCE_CONFIG.scope,
                code_challenge: codeChallenge,
                code_challenge_method: 'S256'
            });
            window.location.href = `${SALESFORCE_CONFIG.authUrl}?${authParams}`;
        }

        async function handleOAuthCallback(code) {
    try {
        const response = await fetch('/.netlify/functions/token-exchange', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                code: code,
                code_verifier: sessionStorage.getItem('pkce_code_verifier'),
                redirect_uri: SALESFORCE_CONFIG.redirectUri
            })
        });
        const data = await response.json();
        accessToken = data.access_token;
        instanceUrl = data.instance_url;
        
        if (data.refresh_token) {
            localStorage.setItem('sf_refresh_token', data.refresh_token);
        }
        
        localStorage.setItem('sf_access_token', accessToken);
        localStorage.setItem('sf_instance_url', instanceUrl);
        sessionStorage.removeItem('pkce_code_verifier');
        window.history.replaceState({}, document.title, window.location.pathname);
        await loadUserInfo();
    } catch (error) {
        showError(`OAuth Error: ${error.message}`);  // ‚Üê Also fixed backtick
    }
}
        async function refreshAccessToken() {
    const refreshToken = localStorage.getItem('sf_refresh_token');
    
    if (!refreshToken) {
        console.log('No refresh token available, need to re-login');
        logout();
        return false;
    }
    
    try {
        const response = await fetch('/.netlify/functions/token-exchange', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                refresh_token: refreshToken
            })
        });
        
        if (!response.ok) {
            throw new Error('Token refresh failed');
        }
        
        const data = await response.json();
        accessToken = data.access_token;
        localStorage.setItem('sf_access_token', accessToken);
        
        console.log('Access token refreshed successfully');
        return true;
    } catch (error) {
        console.error('Failed to refresh token:', error);
        showError('Session expired. Please login again.');
        logout();
        return false;
    }
}
        let tokenRefreshInterval = null;

function startTokenRefresh() {
    stopTokenRefresh();
    tokenRefreshInterval = setInterval(async () => {
        console.log('Auto-refreshing Salesforce token...');
        await refreshAccessToken();
    }, 90 * 60 * 1000);
}

function stopTokenRefresh() {
    if (tokenRefreshInterval) {
        clearInterval(tokenRefreshInterval);
        tokenRefreshInterval = null;
    }
}
        function loadUserSession() {
            accessToken = localStorage.getItem('sf_access_token');
            instanceUrl = localStorage.getItem('sf_instance_url');
            if (accessToken && instanceUrl) loadUserInfo();
        }

        async function loadUserInfo() {
    try {
        const response = await fetch('/.netlify/functions/userinfo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ access_token: accessToken, instance_url: instanceUrl })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to authenticate');
        }
        
        const userInfo = await response.json();
        document.getElementById('userName').textContent = userInfo.name || 'User';
        document.getElementById('userOrg').textContent = userInfo.organization_id || 'Salesforce Org';
        const controlsBar = document.querySelector('.controls-bar');
        if (controlsBar) controlsBar.setAttribute('data-username', userInfo.name || 'User');
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboardScreen').style.display = 'block';
        isAuthenticated = true;
        
        checkFormValid();
        showSuccess('Successfully connected to Salesforce!');

         startTokenRefresh();  // ‚Üê ADD THIS
    } catch (error) {
        showError(`Authentication failed: ${error.message}`);
        logout();
    }
}

        function logout() {
    localStorage.clear();
    isAuthenticated = false;
    unsubscribeFromSupabase();
    stopAutoSave();
    stopTokenRefresh();
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('dashboardScreen').style.display = 'none';
}

        function subscribeToSupabase() {
            if (!supabaseClient) return;
            
            supabaseSubscription = supabaseClient.channel('dialer_status')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'dialer_status', 
                        filter: `session_id=eq.${sessionId}` 
                    },
                    (payload) => { 
                        handleStatusUpdate(payload.new); 
                    }
                ).subscribe();
        }
        
        function subscribeForInbound() {
            if (!supabaseClient || !isAuthenticated) return;
            
            if (supabaseSubscription) {
                console.log('Already subscribed to inbound calls');
                return;
            }
            
            const repPhone = '+1' + document.getElementById('repPhone').value.replace(/\D/g, '');
            if (repPhone.length !== 12) return;
            
            supabaseSubscription = supabaseClient.channel('inbound_dialer')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'dialer_status', 
                        filter: `rep_phone=eq.${repPhone.replace('+1', ' 1')}` 
                    },
                    (payload) => { 
                        handleStatusUpdate(payload.new); 
                    }
                ).subscribe();
            
            console.log('Subscribed to inbound calls for:', repPhone);
        }
        
        function unsubscribeFromSupabase() {
            if (supabaseSubscription && supabaseClient) {
                supabaseClient.removeChannel(supabaseSubscription);
                supabaseSubscription = null;
            }
        }

        function handleStatusUpdate(data) {
            const status = data.event_type;
            
            if (status === 'workflow_started') {
                currentSessionStats.sessionId = data.session_id;
                if (!currentSessionStats.startTime) {
                    currentSessionStats.startTime = new Date(data.created_at).getTime();
                }
                updateStatsDisplay();
            } 
            else if (status === 'call_initiated') {
                currentSessionStats.totalCalls++;
                
                const contact = {
                    name: data.contact_name,
                    company: data.contact_company,
                    phone: data.contact_phone,
                    region: data.contact_region,
                    team: data.contact_team,
                    licenses: data.licenses,
                    years_at_firm: data.years_at_firm,
                    call_sid: data.call_sid,
                    status: 'ringing'
                };
                
                currentBatchContacts.set(data.call_sid, contact);
                
                const index = currentBatchContacts.size - 1;
                populateRaceCard(data.call_sid, contact, index);
                
                updateStatsDisplay();
            }
            else if (status === 'machine_detected') {
                currentSessionStats.machines++;
                
                const contact = currentBatchContacts.get(data.call_sid);
                if (contact) {
                    contact.status = 'machine';
                    updateRaceCard(data.call_sid, 'machine');
                }
                
                updateStatsDisplay();
            }
            else if (status === 'call_busy') {
                const contact = currentBatchContacts.get(data.call_sid);
                if (contact) {
                    contact.status = 'busy';
                    contact.busyType = 'call_busy';
                    updateRaceCard(data.call_sid, 'busy', 'call_busy');
                }
            }
            else if (status === 'call_failed') {
                const contact = currentBatchContacts.get(data.call_sid);
                if (contact) {
                    contact.status = 'busy';
                    contact.busyType = 'call_failed';
                    updateRaceCard(data.call_sid, 'busy', 'call_failed');
                }
            }
            else if (status === 'call_no_answer') {
                const contact = currentBatchContacts.get(data.call_sid);
                if (contact) {
                    contact.status = 'busy';
                    contact.busyType = 'call_no_answer';
                    updateRaceCard(data.call_sid, 'busy', 'call_no_answer');
                }
            }
            else if (status === 'call_canceled') {
                const contact = currentBatchContacts.get(data.call_sid);
                if (contact) {
                    contact.status = 'busy';
                    contact.busyType = 'call_canceled';
                    updateRaceCard(data.call_sid, 'busy', 'call_canceled');
                }
            }
            else if (status === 'human_answered' || status === 'inbound_call') {
                currentSessionStats.connects++;
                currentSessionStats.humanAnsweredTime = new Date(data.created_at).getTime();
                
                if (status === 'inbound_call') {
                    showHeroCard(data);
                    document.getElementById('callRaceContainer').classList.remove('active');
                    document.getElementById('callRaceGrid').innerHTML = '';
                    currentBatchContacts.clear();
               } else {
                    // For outbound calls, find the contact by phone number since call_sid might not match
                    let foundCallSid = null;
                    currentBatchContacts.forEach((contact, sid) => {
                        if (normalizePhone(contact.phone) === normalizePhone(data.contact_phone)) {
                            foundCallSid = sid;
                            contact.status = 'human';
                        }
                    });
                    
                    if (foundCallSid) {
                        updateRaceCard(foundCallSid, 'human');
                    } else {
                        console.warn('Could not find matching contact for human_answered event', data);
                    }
                }
                
                updateStatus('on-call', 'On Call');
                
                isDialing = false;
                unsubscribeFromSupabase();
                
                document.getElementById('stopButton').style.display = 'none';
document.getElementById('startButton').style.display = 'inline-block';
updateStatus('idle', 'System Ready');
                
                document.getElementById('repPhone').disabled = false;
                document.getElementById('teamSelect').disabled = false;
                document.getElementById('regionSelect').disabled = false;
                checkFormValid();
                
                updateStatsDisplay();
            }
            else if (status === 'call_completed') {
                if (currentSessionStats.humanAnsweredTime) {
                    const duration = (new Date(data.created_at).getTime() - currentSessionStats.humanAnsweredTime) / 1000;
                    if (duration > 0 && duration < 3600) {
                        currentSessionStats.callDurations.push(duration);
                    }
                    currentSessionStats.humanAnsweredTime = null;
                }
                updateStatsDisplay();
            }
        }

        async function startDialing() {
            const repPhone = '+1' + document.getElementById('repPhone').value.replace(/\D/g, '');
            const team = document.getElementById('teamSelect').value;
            const region = document.getElementById('regionSelect').value;

            if (!checkUnsavedNotes()) {
                return;
            }

            try {
                isDialing = true;
                isPaused = false;
                sessionId = 'session_' + Date.now();

                currentBatchContacts.clear();
                document.getElementById('callRaceGrid').innerHTML = '';
                hasUnsavedNotes = false;
                currentNoteCallSid = null;

                document.getElementById('startButton').style.display = 'none';
                document.getElementById('stopButton').style.display = 'inline-block';
                document.getElementById('repPhone').disabled = true;
                document.getElementById('teamSelect').disabled = true;
                document.getElementById('regionSelect').disabled = true;
                
                updateStatus('dialing', 'Dialing Active');
                showEmptyRaceCards();
                subscribeToSupabase();

                await fetch(`${N8N_WEBHOOK_BASE}/start-dialing`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'start',
                        session_id: sessionId,
                        rep_phone: repPhone,
                        team: team,
                        region: region,
                        access_token: accessToken,
                        instance_url: instanceUrl
                    })
                });

                localStorage.setItem('current_rep_phone', repPhone);
                showSuccess(`Dialing started for Team ${team} in ${region} region`);
                
                startAutoSave();
                startInactivityMonitor();
            } catch (error) {
                showError(`Failed to start dialing: ${error.message}`);
                resetDialingState();
            }
        }

        async function stopDialing() {
    try {
        const repPhone = localStorage.getItem('current_rep_phone');
        
        await fetch(`${N8N_WEBHOOK_BASE}/stop-dialing`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                action: 'stop', 
                session_id: sessionId,
                rep_phone: repPhone
            })
        });
        
        document.getElementById('callRaceContainer').classList.remove('active');
        document.getElementById('callRaceGrid').innerHTML = '';
        currentBatchContacts.clear();
        
        isDialing = false;
        unsubscribeFromSupabase();
        stopAutoSave();
        stopInactivityMonitor();
        
        document.getElementById('stopButton').style.display = 'none';
        document.getElementById('startButton').style.display = 'inline-block';
        
        document.getElementById('repPhone').disabled = false;
        document.getElementById('teamSelect').disabled = false;
        document.getElementById('regionSelect').disabled = false;
        updateStatus('idle', 'System Ready');
        checkFormValid();
        
        showSuccess('Dialing stopped');
    } catch (error) {
        showError(`Failed to stop: ${error.message}`);
        
        document.getElementById('callRaceContainer').classList.remove('active');
        document.getElementById('callRaceGrid').innerHTML = '';
        currentBatchContacts.clear();
        isDialing = false;
        unsubscribeFromSupabase();
        stopAutoSave();
        
        document.getElementById('stopButton').style.display = 'none';
        document.getElementById('startButton').style.display = 'inline-block';
        
        document.getElementById('repPhone').disabled = false;
        document.getElementById('teamSelect').disabled = false;
        document.getElementById('regionSelect').disabled = false;
        updateStatus('idle', 'System Ready');
        checkFormValid();
    }
}
        function resetDialingState() {
            isDialing = false;
            isPaused = false;
            unsubscribeFromSupabase();
            stopAutoSave();
            stopInactivityMonitor();
            document.getElementById('startButton').style.display = 'inline-block';
            document.getElementById('stopButton').style.display = 'none';
            document.getElementById('repPhone').disabled = false;
            document.getElementById('teamSelect').disabled = false;
            document.getElementById('regionSelect').disabled = false;
            updateStatus('idle', 'System Ready');
            checkFormValid();
        }

        function updateStatus(state, text) {
            document.getElementById('dialerStatus').className = `status-indicator ${state}`;
            document.getElementById('statusText').textContent = text;
        }

        function showEmptyRaceCards() {
            const container = document.getElementById('callRaceContainer');
            const grid = document.getElementById('callRaceGrid');
            
            grid.innerHTML = '';
            
            for (let i = 0; i < 3; i++) {
                const card = document.createElement('div');
                card.className = 'race-card dialing-placeholder';
                card.id = `race-card-placeholder-${i}`;
                
                card.innerHTML = `
                    <div class="race-card-status">
                        <span class="race-status-icon">‚è≥</span>
                        <span>Dialing...</span>
                    </div>
                    <div class="race-card-name">Searching for contact</div>
                    <div class="race-card-info">Preparing call ${i + 1}</div>
                `;
                
                grid.appendChild(card);
            }
            
            container.classList.add('active');
        }
        
        function populateRaceCard(callSid, contact, index) {
            const placeholder = document.getElementById(`race-card-placeholder-${index}`);
            if (!placeholder) return;
            
            placeholder.id = `race-card-${callSid}`;
            placeholder.className = 'race-card ringing';
            placeholder.innerHTML = `
                <div class="race-card-status">
                    <span class="race-status-icon">üìû</span>
                    <span>Ringing...</span>
                </div>
                <div class="race-card-name">${contact.name}</div>
                <div class="race-card-info"><strong>${contact.company || 'No company'}</strong></div>
                <div class="race-card-info">${contact.phone || 'No phone'}</div>
                <div class="race-card-info">Region: ${contact.region || '-'} | Team: ${contact.team || '-'}</div>
                <div class="race-card-info">Licenses: ${contact.licenses || '-'}</div>
                <div class="race-card-info">Years: ${contact.years_at_firm || '-'}</div>
            `;
        }

        function updateRaceCard(callSid, status, busyType = null) {
            const card = document.getElementById(`race-card-${callSid}`);
            if (!card) return;
            
            card.classList.remove('ringing', 'human', 'machine', 'busy', 'ended');
            
            if (status === 'human') {
                card.classList.add('human');
                
                playSuccessChime();
                
                const winnerBadge = document.createElement('div');
                winnerBadge.className = 'race-winner-badge';
                winnerBadge.textContent = 'WINNER';
                card.appendChild(winnerBadge);

                const dispositionBtn = document.createElement('button');
dispositionBtn.className = 'race-disposition-btn';
dispositionBtn.textContent = 'üè∑Ô∏è';
dispositionBtn.onclick = (e) => {
    e.stopPropagation();
    toggleDispositionCompartment(callSid);
};
card.appendChild(dispositionBtn);

                const noteBtn = document.createElement('button');
                noteBtn.className = 'race-note-btn';
                noteBtn.textContent = 'üìù';
                noteBtn.onclick = (e) => {
                    e.stopPropagation();
                    toggleNoteCompartment(callSid);
                };
                card.appendChild(noteBtn);
                
                const optoutBtn = document.createElement('button');
optoutBtn.className = 'race-optout-btn';
optoutBtn.textContent = 'üö´';
optoutBtn.onclick = (e) => {
    e.stopPropagation();
    markRaceCardOptOut(callSid);
};
card.appendChild(optoutBtn);

                const dispositionCompartment = document.createElement('div');
dispositionCompartment.className = 'disposition-compartment';
dispositionCompartment.id = `disposition-compartment-${callSid}`;
dispositionCompartment.innerHTML = `
    <div class="disposition-compartment-header">
        Select Call Outcome
    </div>
    <div class="disposition-option" onclick="selectDisposition('${callSid}', 'Interested')">
        ‚úÖ Interested
    </div>
    <div class="disposition-option" onclick="selectDisposition('${callSid}', 'Not Interested')">
        ‚ùå Not Interested
    </div>
    <div class="disposition-option" onclick="selectDisposition('${callSid}', 'Callback')">
        üìû Callback Requested
    </div>
    <div class="disposition-option" onclick="selectDisposition('${callSid}', 'Wrong Number')">
        ‚ùì Wrong Number
    </div>
`;
card.appendChild(dispositionCompartment);

                const contact = currentBatchContacts.get(callSid);
                const noteCompartment = document.createElement('div');
                noteCompartment.className = 'note-compartment';
                noteCompartment.id = `note-compartment-${callSid}`;
                noteCompartment.innerHTML = `
                    <div class="note-compartment-header">
                        Call Notes
                    </div>
                    <div class="note-compartment-subheader">
                        ${contact?.name || 'Contact'}
                    </div>
                    <textarea 
                        class="note-textarea" 
                        placeholder="Type your notes here..."
                        id="note-text-${callSid}"
                        oninput="markNoteAsUnsaved('${callSid}')"
                    ></textarea>
                    <div class="note-actions">
                        <button class="note-btn note-btn-cancel" onclick="toggleNoteCompartment('${callSid}')">Cancel</button>
                        <button class="note-btn note-btn-save" id="note-save-btn-${callSid}" onclick="saveNoteToSalesforce('${callSid}')">Save</button>
                    </div>
                `;
                card.appendChild(noteCompartment);
                
                card.querySelector('.race-card-status').innerHTML = `
                    <span class="race-status-icon">‚úì</span>
                    <span>Human Answered</span>
                `;
                
// ‚úÖ ADD THESE 12 LINES HERE:
for (let i = 0; i < 3; i++) {
    const placeholderCard = document.getElementById(`race-card-placeholder-${i}`);
    if (placeholderCard) {
        placeholderCard.classList.remove('dialing-placeholder', 'ringing');
        placeholderCard.classList.add('ended');
        placeholderCard.querySelector('.race-card-status').innerHTML = `
            <span class="race-status-icon">‚úï</span>
            <span>Call Ended</span>
        `;
    }
}
                
                currentBatchContacts.forEach((contact, sid) => {
                    if (sid !== callSid && contact.status === 'ringing') {
                        const otherCard = document.getElementById(`race-card-${sid}`);
                        if (otherCard) {
                            otherCard.classList.remove('ringing');
                            otherCard.classList.add('ended');
                            otherCard.querySelector('.race-card-status').innerHTML = `
                                <span class="race-status-icon">‚úï</span>
                                <span>Call Ended</span>
                            `;
                        }
                    }
                });
            } 
            else if (status === 'machine') {
                card.classList.add('machine');
                card.querySelector('.race-card-status').innerHTML = `
                    <span class="race-status-icon">ü§ñ</span>
                    <span>Voicemail</span>
                `;
            }
            else if (status === 'busy') {
                card.classList.add('busy');
                let icon = 'üö´';
                let text = 'Call Busy';
                
                if (busyType === 'call_busy') {
                    icon = 'üåô';
                    text = 'Call Busy';
                } else if (busyType === 'call_failed') {
                    icon = '‚ö†Ô∏è';
                    text = 'Call Failed';
                } else if (busyType === 'call_no_answer') {
                    icon = '‚è±Ô∏è';
                    text = 'No Answer';
                } else if (busyType === 'call_canceled') {
                    icon = 'üö´';
                    text = 'Call Canceled';
                }
                
                card.querySelector('.race-card-status').innerHTML = `
                    <span class="race-status-icon">${icon}</span>
                    <span>${text}</span>
                `;
            }
        }

        function toggleNoteCompartment(callSid) {
            const compartment = document.getElementById(`note-compartment-${callSid}`);
            if (compartment) {
                compartment.classList.toggle('open');
            }
        }

        function markNoteAsUnsaved(callSid) {
            const noteText = document.getElementById(`note-text-${callSid}`).value.trim();
            const saveBtn = document.getElementById(`note-save-btn-${callSid}`);
            
            if (noteText) {
                hasUnsavedNotes = true;
                currentNoteCallSid = callSid;
                
                if (saveBtn && saveBtn.classList.contains('saved')) {
                    saveBtn.classList.remove('saved');
                    saveBtn.textContent = 'Save';
                    saveBtn.disabled = false;
                }
            } else if (!noteText) {
                hasUnsavedNotes = false;
                currentNoteCallSid = null;
            }
        }
        
        function markHeroNoteAsUnsaved() {
            const noteText = document.getElementById('heroNoteText')?.value.trim();
            const saveBtn = document.getElementById('heroNoteSaveBtn');
            
            if (saveBtn && saveBtn.classList.contains('saved') && noteText) {
                saveBtn.classList.remove('saved');
                saveBtn.textContent = 'Save';
                saveBtn.disabled = false;
            }
        }
        
        function checkUnsavedNotes() {
            if (hasUnsavedNotes && currentNoteCallSid) {
                const noteText = document.getElementById(`note-text-${currentNoteCallSid}`)?.value.trim();
                const saveBtn = document.getElementById(`note-save-btn-${currentNoteCallSid}`);
                
                if (noteText && saveBtn && !saveBtn.classList.contains('saved')) {
                    return confirm('You have unsaved notes in a race card. Are you sure you want to continue? Your notes will be lost.');
                }
            }
            
            const heroNoteText = document.getElementById('heroNoteText')?.value.trim();
            const heroSaveBtn = document.getElementById('heroNoteSaveBtn');
            
            if (heroNoteText && heroSaveBtn && !heroSaveBtn.classList.contains('saved')) {
                return confirm('You have unsaved notes in the hero card. Are you sure you want to continue? Your notes will be lost.');
            }
            
            return true;
        }

        function trackActivity() {
    lastActivityTime = Date.now();
    
    if (inactivityWarningShown) {
        dismissInactivityWarning();
    }
}

function startInactivityMonitor() {
    stopInactivityMonitor();
    
    // Reset activity tracking
    lastActivityTime = Date.now();
    inactivityWarningShown = false;
    
    // Add activity listeners
    ['mousedown', 'keydown', 'touchstart', 'scroll'].forEach(event => {
        document.addEventListener(event, trackActivity);
    });
    
    // Check every minute
    inactivityTimer = setInterval(() => {
        const inactiveMinutes = (Date.now() - lastActivityTime) / 60000;
        
        // 30 min inactive ‚Üí show warning
        if (inactiveMinutes >= 30 && !inactivityWarningShown) {
            showInactivityWarning();
        }
        
        // 32 min inactive (30 + 2 min grace) ‚Üí auto-stop
        if (inactiveMinutes >= 32) {
            console.log('Auto-stopping due to inactivity');
            stopDialing();
        }
    }, 60000); // Check every minute
}

function stopInactivityMonitor() {
    if (inactivityTimer) {
        clearInterval(inactivityTimer);
        inactivityTimer = null;
    }
    
    ['mousedown', 'keydown', 'touchstart', 'scroll'].forEach(event => {
        document.removeEventListener(event, trackActivity);
    });
    
    dismissInactivityWarning();
}

function showInactivityWarning() {
    inactivityWarningShown = true;
    
    const warning = document.createElement('div');
    warning.id = 'inactivityWarning';
    warning.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #1a1a1a;
        border: 2px solid rgba(239, 68, 68, 0.6);
        border-radius: 16px;
        padding: 32px;
        z-index: 10000;
        text-align: center;
        box-shadow: 0 0 40px rgba(239, 68, 68, 0.4);
    `;
    
    warning.innerHTML = `
        <div style="color: #ffffff; font-size: 24px; font-weight: 700; margin-bottom: 16px;">
            ‚è∞ Are you still there?
        </div>
        <div style="color: rgba(255, 255, 255, 0.7); font-size: 16px; margin-bottom: 24px;">
            No activity detected for 30 minutes.<br>
            Session will auto-stop in 2 minutes.
        </div>
        <button onclick="trackActivity()" style="
            background: rgba(34, 197, 94, 0.9);
            color: white;
            border: none;
            padding: 12px 32px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
        ">
            Yes, I'm Still Here
        </button>
    `;
    
    document.body.appendChild(warning);
}

function dismissInactivityWarning() {
    const warning = document.getElementById('inactivityWarning');
    if (warning) {
        warning.remove();
        inactivityWarningShown = false;
    }
}
        
        function startAutoSave() {
            stopAutoSave();
            stopInactivityMonitor();
            
            autoSaveInterval = setInterval(() => {
                autoSaveNotes();
            }, 30000);
        }

        function stopAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
            }
        }

        function autoSaveNotes() {
            const drafts = {};
            
            currentBatchContacts.forEach((contact, callSid) => {
                const noteText = document.getElementById(`note-text-${callSid}`)?.value.trim();
                if (noteText) {
                    drafts[callSid] = {
                        text: noteText,
                        contact: contact.name,
                        timestamp: Date.now()
                    };
                }
            });
            
            const heroNoteText = document.getElementById('heroNoteText')?.value.trim();
            if (heroNoteText && currentHeroCallSid) {
                drafts['hero_' + currentHeroCallSid] = {
                    text: heroNoteText,
                    contact: currentHeroContact?.name,
                    timestamp: Date.now()
                };
            }
            
            if (Object.keys(drafts).length > 0) {
                localStorage.setItem('note_drafts', JSON.stringify(drafts));
                console.log('Auto-saved', Object.keys(drafts).length, 'note draft(s)');
            }
        }

        async function saveNoteToSalesforce(callSid) {
            const noteText = document.getElementById(`note-text-${callSid}`).value.trim();
            
            if (!noteText) {
                showError('Please enter a note before saving.');
                return;
            }

            const contact = currentBatchContacts.get(callSid);
            if (!contact) {
                showError('Contact information not found.');
                return;
            }

            const saveBtn = document.getElementById(`note-save-btn-${callSid}`);
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                const response = await fetch(`${N8N_WEBHOOK_BASE}/save-note`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        call_sid: callSid,
                        contact_name: contact.name,
                        contact_phone: contact.phone,
                        note: noteText,
                        access_token: accessToken,
                        instance_url: instanceUrl
                    })
                });

                const result = await response.json();

if (response.ok) {
                    showSuccess('Note saved to Salesforce!');
                    saveBtn.textContent = 'Saved';
                    saveBtn.classList.add('saved');
                    saveBtn.disabled = true;
                    hasUnsavedNotes = false;
                    currentNoteCallSid = null;
                    
                    const drafts = JSON.parse(localStorage.getItem('note_drafts') || '{}');
                    delete drafts[callSid];
                    localStorage.setItem('note_drafts', JSON.stringify(drafts));
                } else {
                        showError(result.error || 'Failed to save note to Salesforce.');
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save';
                }
            } catch (error) {
                showError(`Error saving note: ${error.message}`);
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save';
            }
        }

function toggleDispositionCompartment(callSid) {
    const compartment = document.getElementById(`disposition-compartment-${callSid}`);
    if (compartment) {
        compartment.classList.toggle('open');
    }
}

async function selectDisposition(callSid, disposition) {
    const contact = currentBatchContacts.get(callSid);
    
    if (!contact) {
        showError('Contact not found');
        return;
    }
    
    // Visual feedback
    const compartment = document.getElementById(`disposition-compartment-${callSid}`);
    const options = compartment.querySelectorAll('.disposition-option');
    options.forEach(opt => opt.classList.remove('selected'));
    event.target.classList.add('selected');
    
    // Save to Salesforce
    try {
        await fetch(`${N8N_WEBHOOK_BASE}/save-disposition`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                call_sid: callSid,
                contact_phone: contact.phone,
                contact_name: contact.name,
                disposition: disposition,
                access_token: accessToken,
                instance_url: instanceUrl
            })
        });
        
        showSuccess(`Disposition saved: ${disposition}`);
        
        setTimeout(() => {
            compartment.classList.remove('open');
        }, 1000);
    } catch (error) {
        showError(`Failed to save disposition: ${error.message}`);
    }
}
        
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'message error';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 3000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'message success';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }

        function showHeroCard(data) {
            playPhoneRing();
            
            currentHeroCallSid = data.call_sid;
            currentHeroContact = {
                name: data.contact_name,
                company: data.contact_company,
                phone: data.contact_phone,
                region: data.contact_region,
                team: data.contact_team,
                licenses: data.licenses,
                years_at_firm: data.years_at_firm
            };

            document.getElementById('heroCardName').textContent = data.contact_name || 'Unknown Caller';
            document.getElementById('heroCardCompany').textContent = data.contact_company || '-';
            document.getElementById('heroCardPhone').textContent = data.contact_phone || '-';
            document.getElementById('heroCardRegionTeam').textContent = 
                `${data.contact_region || '-'} ‚Ä¢ ${data.contact_team || '-'}`;
            document.getElementById('heroCardLicenses').textContent = data.licenses || '-';
            document.getElementById('heroCardYears').textContent = data.years_at_firm ? `${data.years_at_firm} years` : '-';

            document.getElementById('heroNoteCompartment').classList.remove('open');
            document.getElementById('heroNoteText').value = '';
            document.getElementById('heroNoteSaveBtn').classList.remove('saved');
            document.getElementById('heroNoteSaveBtn').textContent = 'Save';

            document.getElementById('heroCardContainer').classList.add('active');
        }

        function dismissHeroCard() {
            document.getElementById('heroCardContainer').classList.remove('active');
            currentHeroCallSid = null;
            currentHeroContact = null;
            
            updateStatus('idle', 'System Ready');
        }

        async function markRaceCardOptOut(callSid) {
    const contact = currentBatchContacts.get(callSid);
    
    if (!contact) {
        showError('Contact information not found');
        return;
    }
    
    if (!confirm(`Mark ${contact.name} as Do Not Call?\n\nThis contact will never be called again.`)) {
        return;
    }
    
    try {
        const response = await fetch(`${N8N_WEBHOOK_BASE}/opt-out-contact`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contact_phone: contact.phone,
                contact_name: contact.name,
                access_token: accessToken,
                instance_url: instanceUrl
            })
        });
        
        if (response.ok) {
            showSuccess(`${contact.name} marked as Do Not Call`);
        } else {
            showError('Failed to update DNC status');
        }
    } catch (error) {
        showError(`Error: ${error.message}`);
    }
}

        function toggleHeroDisposition() {
    const compartment = document.getElementById('heroDispositionCompartment');
    compartment.classList.toggle('open');
}

async function selectHeroDisposition(disposition) {
    if (!currentHeroContact) {
        showError('Contact not found');
        return;
    }
    
    const compartment = document.getElementById('heroDispositionCompartment');
    const options = compartment.querySelectorAll('.disposition-option');
    options.forEach(opt => opt.classList.remove('selected'));
    event.target.classList.add('selected');
    
    try {
        await fetch(`${N8N_WEBHOOK_BASE}/save-disposition`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                call_sid: currentHeroCallSid,
                contact_phone: currentHeroContact.phone,
                contact_name: currentHeroContact.name,
                disposition: disposition,
                access_token: accessToken,
                instance_url: instanceUrl
            })
        });
        
        showSuccess(`Disposition saved: ${disposition}`);
        
        setTimeout(() => {
            compartment.classList.remove('open');
        }, 1000);
    } catch (error) {
        showError(`Failed to save disposition: ${error.message}`);
    }
}

async function markHeroOptOut() {
    if (!currentHeroContact) {
        showError('Contact information not found');
        return;
    }
    
    if (!confirm(`Mark ${currentHeroContact.name} as Do Not Call?\n\nThis contact will never be called again.`)) {
        return;
    }
    
    try {
        const response = await fetch(`${N8N_WEBHOOK_BASE}/opt-out-contact`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contact_phone: currentHeroContact.phone,
                contact_name: currentHeroContact.name,
                access_token: accessToken,
                instance_url: instanceUrl
            })
        });
        
        if (response.ok) {
            showSuccess(`${currentHeroContact.name} marked as Do Not Call`);
        } else {
            showError('Failed to update DNC status');
        }
    } catch (error) {
        showError(`Error: ${error.message}`);
    }
}
        
        function toggleHeroNote() {
            const compartment = document.getElementById('heroNoteCompartment');
            compartment.classList.toggle('open');
        }

        async function saveHeroNote() {
            const noteText = document.getElementById('heroNoteText').value.trim();
            
            if (!noteText) {
                showError('Please enter a note before saving.');
                return;
            }

            if (!currentHeroContact) {
                showError('Contact information not found.');
                return;
            }

            const saveBtn = document.getElementById('heroNoteSaveBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                const response = await fetch(`${N8N_WEBHOOK_BASE}/save-note`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        call_sid: currentHeroCallSid,
                        contact_name: currentHeroContact.name,
                        contact_phone: currentHeroContact.phone,
                        note: noteText,
                        access_token: accessToken,
                        instance_url: instanceUrl
                    })
                });

                const result = await response.json();  // ‚Üê ADD THIS LINE

                if (response.ok) {
                    showSuccess('Note saved to Salesforce!');
                    saveBtn.textContent = 'Saved ‚úì';
                    saveBtn.classList.add('saved');
                    saveBtn.disabled = true;
                    
                    const drafts = JSON.parse(localStorage.getItem('note_drafts') || '{}');
                    delete drafts['hero_' + currentHeroCallSid];
                    localStorage.setItem('note_drafts', JSON.stringify(drafts));
                } else {
    showError(result.error || 'Failed to save note to Salesforce.');
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save';
                }
            } catch (error) {
                showError(`Error saving note: ${error.message}`);  // ‚Üê Fixed: use ( not `
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save';
            }
        }

        // Reconnect Supabase when tab becomes active
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                console.log('Tab became active - checking Supabase connection');
                
                // If we should be subscribed but aren't, reconnect
                const repPhone = normalizePhone(document.getElementById('repPhone').value);
                
                if (isAuthenticated && repPhone.length === 12 && !supabaseSubscription) {
                    console.log('Reconnecting Supabase subscription...');
                    subscribeForInbound();
                    showSuccess('Reconnected to real-time updates');
                }
            }
        });

        window.addEventListener('DOMContentLoaded', async () => {
            await initSupabase();
            
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
            }
            
            const lastResetDate = localStorage.getItem('lastStatsReset');
            const today = new Date().toDateString();
            
            if (lastResetDate !== today) {
                resetSessionStats();
                localStorage.setItem('lastStatsReset', today);
            } else {
                const savedStats = localStorage.getItem('dailyStats');
                if (savedStats) {
                    const parsed = JSON.parse(savedStats);
                    currentSessionStats.totalCalls = parsed.totalCalls || 0;
                    currentSessionStats.connects = parsed.connects || 0;
                    currentSessionStats.machines = parsed.machines || 0;
                    currentSessionStats.callDurations = parsed.callDurations || [];
                    currentSessionStats.startTime = parsed.startTime || null;
                    updateStatsDisplay();
                }
            }
            
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            if (code) {
                handleOAuthCallback(code);
            } else if (localStorage.getItem('sf_access_token')) {
                loadUserSession();
            }
            
            document.getElementById('repPhone').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 10) value = value.slice(0, 10);
                if (value.length >= 6) {
                    value = `(${value.slice(0,3)}) ${value.slice(3,6)}-${value.slice(6)}`;
                } else if (value.length >= 3) {
                    value = `(${value.slice(0,3)}) ${value.slice(3)}`;
                }
                e.target.value = value;
                checkFormValid();
            });
            
document.getElementById('teamSelect').addEventListener('change', checkFormValid);
            document.getElementById('regionSelect').addEventListener('change', checkFormValid);
        });
    </script>
</body>
</html>
